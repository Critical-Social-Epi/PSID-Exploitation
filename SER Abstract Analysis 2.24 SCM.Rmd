---
title: "SER Abstract Analysis - Heads of Household Only"
output: html_notebook
---

```{r, setup}
library(tidyverse)
library(magrittr)
library(dplyr)
library(gtools)
library(plyr)
load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/AnalysisData.Rdata")

```
#before restricting, get spouse's income info to make composite variable
```{r}
AnalysisData$SpouseIncome1 <- AnalysisData$TotalLaborIncome1.Spouse
AnalysisData$SpouseIncome2<-AnalysisData$TotalLaborIncome2.Spouse

``` 
#Restrict data to heads of household (since only they are asked K6)
```{r}
df <- AnalysisData %>% 
                    select(-contains(".Spouse")) %>% 
                    filter(RelationToHead==10)
colnames(df)
```

#For every respondent from 2003-2015 (when K6 asked), go back as far as their first year of participation - 1983
```{r}
UniqueIDs <- df %>% filter(Year %in% c("2003", "2005", "2007", "2009", "2011", "2013", "2015"))
UniqueIDs <- unique(UniqueIDs$ID)
df <- df %>% filter(ID %in% UniqueIDs)
df$ID<-as.factor(df$ID)

df %>% group_by(Year) %>% summarize(max(Age.Head, na.rm=TRUE))

quantile(df$AgeDrEmotProb.Head, probs=seq(0,1,0.01), na.rm=TRUE)
table(df$AgeDrEmotProb.Head)

table(df$DrEmotProb.Head)
table(df$AgeDrEmotProb.Head>0)
```



#Check variable value options for Qs asked every year
```{r}
# Recode Age

df$Year <- as.numeric(df$Year)

df <- df %>% mutate(Age.Head = ifelse(Year %in% c(1983:1993) & Age.Head>98, NA, ifelse(Year %in% c(1994:1996) &
                                  Age.Head %in% c(0,98,99), NA, ifelse(Year %in% c(1997:2015) & Age.Head > 120, NA,
                                  Age.Head))))
                    
                    
```                    
                    
#baseline variables with structure = age of first report                  
#child health

```{r}

df$Depressed17.Head<-ifelse(df$Depressed17.Head ==1, 1, ifelse(df$Depressed17.Head ==5,0, NA))
df$DrugProb17.Head <- ifelse(df$DrugProb17.Head ==1, 1, ifelse(df$DrugProb17.Head ==5, 0, NA))
df$EmotProb.Head<-ifelse(df$EmotProb.Head ==1, 1, ifelse(df$EmotProb.Head ==5, 0, NA))

#did you ever have poor health as a kid? 1 for fair/poor ever
df$KidHealth<-ifelse(df$KidHealth.Head %in% c(1:3), 0, ifelse(df$KidHealth.Head %in% c(4,5),1, NA))

df<-df %>% group_by(ID) %>% 
  mutate( KidHealth.baseline = any(KidHealth==1),
          Depressed17.Head.baseline = any(Depressed17.Head==1),
          DrugProb17.Head.baseline= any(DrugProb17.Head==1),
          EmotProb.Head.baseline =any(EmotProb.Head==1))
        

```
## age at which doctor told u you had probs
```{r}
df$AgeDrEmotProb.Head<-ifelse(df$AgeDrEmotProb.Head>0, df$AgeDrEmotProb.Head, NA)
df$AgeDrLearnDisord.Head<-ifelse(df$AgeDrLearnDisord.Head>0, df$AgeDrLearnDisord.Head, NA)
df<- df %>% group_by(ID) %>% mutate(
  AgeDrEmotProb.Head.baseline = dplyr::first(na.omit(AgeDrEmotProb.Head)),
   AgeDrLearnDisord.Head.baseline = dplyr::first(na.omit(AgeDrLearnDisord.Head)))

df[,c("Year", "ID", "AgeDrEmotProb.Head", "AgeDrEmotProb.Head.baseline")]
```

#race
```{r}
table(df$Race.Head)
df$Race.Head<-ifelse(df$Race.Head %in% c(1:2), df$Race.Head, ifelse(df$Race.Head %in% c(3:7), 3, NA))
df<- df %>% group_by(ID) %>% mutate(
  Race = dplyr::first(na.omit(Race.Head)))
table(df$Race)
```
#Alcohol use
```{r}
table(df$AlcUse.Head)
##alcohol coding--approximately drinks/week
## if they don't drink, treat as 0/week
## if they drink less than once/week, treat as 0/week
## otherwise this is semicontinuous - if they drink several times a week, multiplyby 3
## if they drink every day, mulitply by 7
df$DrinksPerDay.Head <- ifelse(df$DrinksPerDay.Head %in% c(1:25), df$DrinksPerDay.Head, ifelse(df$DrinksPerDay.Head==0, 0, NA))
df$DrinksPerDay.Head<-as.numeric(df$DrinksPerDay.Head)
df$AlcFreq<-ifelse(df$AlcFreq.Head %in% c(0:3), 0, ifelse(df$AlcFreq.Head==4, df$DrinksPerDay.Head, ifelse(df$AlcFreq.Head==5, df$DrinksPerDay.Head*3, ifelse(df$AlcFreq.Head==6, df$DrinksPerDay.Head*7, NA))))

#create baseline alc variable
df$AlcUse<-ifelse(df$AlcUse.Head==1, 1, ifelse(df$AlcUse.Head==5, 0, NA))
table(df$AlcUse)
df$AlcUse.baseline<-ifelse(df$Year < 2003, df$AlcUse, NA)
table(df$AlcUse.baseline)
```
#pysch condition - only queried starting 2005, no baseline
```{r}

df$ConditionPsych.Head <-ifelse(df$ConditionPsych.Head %in% c(1:9), df$ConditionPsych.Head, NA)
table(df$ConditionPsych.Head, df$Year)

```
##did a doctor ever tell you that you have...
##first asked in 1999
```{r}
df$DrEmotProb.Head<-ifelse(df$DrEmotProb.Head ==1, 1, ifelse(df$DrEmotProb.Head ==5, 0, NA))
df$DrLearnDisord.Head<-ifelse(df$DrLearnDisord.Head ==1, 1, ifelse(df$DrLearnDisord.Head ==5, 0, NA))
df$DrMemLoss.Head<-ifelse(df$DrMemLoss.Head ==1, 1, ifelse(df$DrMemLoss.Head ==5, 0, NA))


df$DrEmotProb.2003<-ifelse(df$Year<2003, df$DrEmotProb.Head, NA)
df$DrLearnDisord.2003<-ifelse(df$Year<2003, df$DrLearnDisord.Head, NA)
df$DrMemLoss.2003<-ifelse(df$Year<2003, df$DrMemLoss.Head, NA)

df<-df %>% group_by(ID) %>% 
  mutate( DrMemLoss.baseline = any(DrMemLoss.2003==1),
          DrEmotProb.baseline = any(DrEmotProb.2003==1),
          DrLearnDisord.baseline = any(DrLearnDisord.2003==1))

```

```{r}
####Employment levels: 1=working, 2=laid off temporarily or looking for work, 3= retired or housewife, 4=permanently disabled, 5=student
df$EmployedNow<-ifelse(df$EmployedNow1.Head==1|df$EmployedNow2.Head==1, 1, ifelse(df$EmployedNow1.Head %in% c(2, 3)|df$EmployedNow2.Head %in% c(2, 3), 2, ifelse(df$EmployedNow1.Head %in% c(4, 6)|df$EmployedNow2.Head %in% c(4,6), 3, ifelse(df$EmployedNow1.Head==5|df$EmployedNow2.Head==5, 4, ifelse(df$EmployedNow1.Head==7|df$EmployedNow2.Head==7, 5, NA)))))
```

```{r}
table(df$EverSmoked.Head, df$Year)
df$EverSmoked.Head <-ifelse(df$EverSmoked.Head ==1, 1, ifelse(df$EverSmoked.Head ==5,0, NA))

#baseline
df$EverSmoked.2003<-ifelse(df$Year<2003, df$EverSmoked.Head, NA)
table(df$EverSmoked.2003)

df<-df %>% group_by(ID) %>% 
  mutate( EverSmoked.baseline = any(EverSmoked.2003==1))
table(df$EverSmoked.2003, df$EverSmoked.baseline)
```
          

```{r}
df$FamilySize<-ifelse(df$FamilySize < 99, df$FamilySize, NA)


#baseline
df$FamilySize.2003<-ifelse(df$Year<2003, df$FamilySize, NA)
df$FamilySize.2003<-as.numeric(df$FamilySize.2003)
table(df$FamilySize.2003)
df.fam<- df %>%
    group_by(ID) %>%
    dplyr::summarize(FamilySize.baseline = mean(FamilySize.2003, na.rm=TRUE))
summary(df$ID)
summary(df.fam$ID)
#merge back
df<-merge(df.fam, df, by="ID", all.y="TRUE", all.x="TRUE")


```


```{r}
#binarize general health - 1 if fair or poor
df$GenHealth <- ifelse(df$GenHealth.Head %in% c(1:3), 0, ifelse(df$GenHealth.Head %in% c(4,5), 1, NA))
#baseline - years of good health
df$GenHealth.2003<-ifelse(df$Year<2003, df$GenHealth, NA)

df<-df %>% group_by(ID) %>%  add_tally(GenHealth.2003)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(GenHealth.baseline=n)

```

```{r}
#lt high school, 12=high school, 13-15 = some college, 16=college, 17=more than college
df$GradesCompl <- ifelse(df$GradesCompl %in% c(1:17), df$GradesCompl, NA)

#baseline

df$GradesCompl.2003<-ifelse(df$Year<2003, df$GradesCompl, NA)
df<- df %>% mutate(
    (GradesCompl.baseline = dplyr::max(GradesCompl.2003)))
```

```{r}
##INSURANCE TIME
df$HealthInsNow<-ifelse(df$HealthInsNow ==1, 1, ifelse(df$HealthInsNow ==5, 0, NA))
df$Industry<-ifelse(df$Year<=1980, df$Industry1980.Head, ifelse(df$Year>1980 & df$Year<=2001, df$Industry2001.Head, ifelse(df$Year>2001, df$Industry2015.Head, NA)))
df$Industry <- ifelse(df$Industry != 999 & df$Industry != 0, df$Industry, NA)
df$InsuredAnyone<-ifelse(df$Insurance2==1 | df$InsuranceHeadFam %in% c(1,2), 1, ifelse(df$Insurance2==5|df$InsuranceHeadFam %in% c(4,5),0,NA))

#baseline - was anyone ever NOT insured? - from 1999

df$InsuredAnyone.2003<-ifelse(df$Year<2003, df$InsuredAnyone, NA)

df<-df %>% group_by(ID) %>% 
  mutate( InsuredAnyone.baseline = any(InsuredAnyone.2003==0))
```


```{r}

#InterestIncome.Head can be coded as is - continuous
summary(df$InterestIncome.Head)
##baseline
df$InterestIncome.2003<-ifelse(df$Year<2003, df$InterestIncome.Head, NA)

df.interest<- df %>%
    group_by(ID) %>%
    dplyr::summarize(InterestIncome.baseline = mean(InterestIncome.2003, na.rm=TRUE))
#merge back
df<-merge(df.interest, df, by="ID", all.y="TRUE", all.x="TRUE")

```

```{r}
df$K6.Head <- ifelse(df$K6.Head<99, df$K6.Head, NA)

```

```{r}
df$MedforPsych.Head<-ifelse(df$MedforPsych.Head == 1, 1, ifelse(df$MedforPsych.Head %in% c(0,5), 0, NA))

df$MedLearnDisord.Head<-ifelse(df$MedLearnDisord.Head == 1, 1, ifelse(df$MedLearnDisord.Head %in% c(0,5), 0, NA))

#baseline
df$MedforPsych.2003<-ifelse(df$Year<2003, df$MedforPsych.Head, NA)

df$MedLearnDisord.2003<-ifelse(df$Year<2003, df$MedLearnDisord.Head, NA)

df<-df %>% group_by(ID) %>% 
  mutate( MedforPsych.baseline = any(MedforPsych.2003==1))
df<-df %>% group_by(ID) %>% 
  mutate( MedLearnDisord.baseline = any(MedLearnDisord.2003==1))
```

```{r}
df$Medicaid<-ifelse(df$Medicaid ==1, 1, ifelse(df$Medicaid ==5, 0, NA))
##not asked after 1996 so all values should be baseline

df<-df %>% group_by(ID) %>%  add_tally(Medicaid)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(Medicaid.baseline=n)
colnames(df)

```

```{r}
df$Occupation<-ifelse(df$Year<=1980, df$Occupation1980.Head, ifelse(df$Year>1980 & df$Year<=2001, df$Occupation2001.Head, ifelse(df$Year>2001, df$Occupation2015.Head, NA)))
df$Occupation <- ifelse(df$Occupation != 998 & df$Occupation!=999 & df$Occupation!=0, df$Occupation, NA)

```

```{r}
df$OwnRent<-ifelse(df$OwnRent ==1 , 1, ifelse(df$OwnRent==5, 0, NA))
table(df$OwnRent, df$Year)
##baseline is years owned

df$OwnRent.2003<-ifelse(df$Year<2003, df$OwnRent, NA)

df<-df %>% group_by(ID) %>%  add_tally(OwnRent.2003)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(OwnRent.baseline=n)
colnames(df)
```

```{r}
##1 = self employed only, 0 if not
df$Self.Head<-ifelse(df$SelEmp2001.Head %in% c(1:3) & df$Year<= 2001, df$SelEmp2001.Head, ifelse(df$SelfEmp2015.Head %in% c(1:3) & df$Year >2001, df$SelfEmp2015.Head, NA))
df$Self.Head<-ifelse(df$Self.Head==3, 1, ifelse(df$Self.Head %in% c(1,2), 0, NA))
table(df$Self.Head, exclude=NULL)

#baseline
df$Self.Head.2003<-ifelse(df$Year<2003, df$Self.Head, NA)

df<-df %>% group_by(ID) %>%  add_tally(Self.Head.2003)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(Self.Head.baseline=n)
colnames(df)
table(df$Self.Head.baseline)
```


```{r}
##TotalLaborIncome.Head not recoded - continuous

## Baseline - average

df$TotalLaborIncome.2003<-ifelse(df$Year<2003, df$TotalLaborIncome.Head, NA)

df.labor<- df %>%
    group_by(ID) %>%
    dplyr::summarize(TotalLaborIncome.baseline = mean(TotalLaborIncome.2003, na.rm=TRUE))
#merge back
df<-merge(df.labor, df, by="ID", all.y="TRUE", all.x="TRUE")
```

#salary or hourly
##HELP
### Check it out
```{r}
load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Hourly/Hourly_Long.Rdata")

names(Hourly_Long)

df$ID <- as.character(df$ID)
Hourly_Long$ID <- as.character(Hourly_Long$ID)
df$Year <- as.character(df$Year)

df_wage_type <- left_join(df, Hourly_Long, by = c("ID" = "ID", "Year" = ".time_1"))
```

```{r}

#Household income = total labor income + spouse labor income + interest income
table(df$SpouseIncome1, df$Year) # thru 1993
table(df$SpouseIncome2, df$Year) #1994 and up

df$SpouseIncome<-ifelse(df$Year <1994, df$SpouseIncome1, ifelse(df$Year %in% c(1994:2018), df$SpouseIncome2, NA))
## Baseline - average
df$SpouseIncome.2003<-ifelse(df$Year<2003, df$SpouseIncome, NA)

df.spouseincome<- df %>%
    group_by(ID) %>%
    dplyr::summarize(SpouseIncome.baseline = mean(SpouseIncome.2003, na.rm=TRUE))
#merge back
df<-merge(df.spouseincome, df,  by="ID", all.y="TRUE", all.x="TRUE")
```

```{r}

df$UnionCovered.Head <-ifelse(df$UnionCovered.Head ==1, 1, ifelse(df$UnionCovered.Head ==5, 0, NA))
table(df$UnionCovered.Head, df$Year)

#baseline
df$UnionCovered.2003<-ifelse(df$Year<2003, df$UnionCovered.Head, NA)

df<-df %>% group_by(ID) %>%  add_tally(UnionCovered.2003)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(UnionCovered.baseline=n)
colnames(df)
table(df$UnionCovered.baseline)
```

```{r}

df$YearsWorked.Head <- ifelse(df$YearsWorked.Head>0 & df$YearsWorked.Head<98, df$YearsWorked.Head, NA)  
#baseline
df$YearsWorked.2003<-ifelse(df$Year<2003, df$YearsWorked.Head, NA)

df<-df %>% group_by(ID) %>%  add_tally(YearsWorked.2003)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(YearsWorked.baseline=n)
colnames(df)


```


```{r}
df$WorkHrs.Head <- ifelse(df$WorkHrs.Head > 0 , df$WorkHrs.Head, NA)

##baseline

df$WorkHrs.2003<-ifelse(df$Year<2003, df$WorkHrs.Head, NA)

df<-df %>% group_by(ID) %>%  add_tally(WorkHrs.2003)
##this automatically creates a column called "n" and now I will rename it
df<- df %>% dplyr::rename(WorkHrs.baseline=n)
colnames(df)



```

#Recode industries and occupations into standard groups, 1970s codes and 2000s codes, collapse into one variable

```{r}

df <- df %>% filter(Year %in% c(2003, 2005, 2007, 2009, 2011, 2013, 2015))
df$Industry <- as.numeric(df$Industry)

df$Industry <-
ifelse(df$Industry>=17 & df$Industry<=29, "Agra/Forest/Fish/Hunt",
ifelse(df$Industry>=37 & df$Industry<=49, "Mining",
ifelse(df$Industry>=57 & df$Industry<=69, "Utilities",
ifelse(df$Industry==77, "Construction",
ifelse(df$Industry>=107 & df$Industry<=399, "Manufacturing",
ifelse(df$Industry>=407 & df$Industry<=459, "Wholesale Trade",
ifelse(df$Industry>=467 & df$Industry<=579, "Retail Trade",
ifelse(df$Industry>=607 & df$Industry<=639, "Transport/Warehousing",
ifelse(df$Industry>=647 & df$Industry<=679, "Information",
ifelse(df$Industry>=687 & df$Industry<=699, "Finance and Insurance",
ifelse(df$Industry>=707 & df$Industry<=719, "Real Estate",
ifelse(df$Industry>=727 & df$Industry<=749, "Pro/Sci/Tech Services",
ifelse(df$Industry>=757 & df$Industry<=779, "Management/Admin&Support/Waste Management",
ifelse(df$Industry>=786 & df$Industry<=789, "Educational Services",
ifelse(df$Industry>=797 & df$Industry<=847, "Health Care/Soc Assistance",
ifelse(df$Industry>=856 & df$Industry<=859, "Arts/Ent/Rec",
ifelse(df$Industry>=866 & df$Industry<=869, "Accomm/Food Services",
ifelse(df$Industry>=877 & df$Industry<=929, "Other Services",
ifelse(df$Industry>=937 & df$Industry<=959, "Public Administration",
ifelse(df$Industry==999, "DK/NA/R",
ifelse(df$Industry==0, "Inap", NA)))))))))))))))))))))

df$Industry <-as.factor(df$Industry)


df$Occupation <- as.numeric(df$Occupation)

df$Occupation<-ifelse(df$Occupation>=1 & df$Occupation<=43, "Management",  
ifelse(df$Occupation>=50 & df$Occupation<=73, "Business Operations Specialists",  
ifelse(df$Occupation>=80 & df$Occupation<= 95, "Financial Specialists",  
ifelse(df$Occupation>=100 & df$Occupation<=124, "Computer/Mathematical",  
ifelse(df$Occupation>=130 & df$Occupation<=156, "Architecture/Engineering",  
ifelse(df$Occupation>=160 & df$Occupation<=196, "Life, Phys, Soc Sciences",  
ifelse(df$Occupation>=200 & df$Occupation<=206, "Community/Soc Services",  
ifelse(df$Occupation>=210 & df$Occupation<=215, "Legal",  
ifelse(df$Occupation>=220 & df$Occupation<=255, "Education, Training, and Library",  
ifelse(df$Occupation>=260 & df$Occupation<=296, "Arts/Entertainment",  
ifelse(df$Occupation>=300 & df$Occupation<=354, "Healthcare Practitioner/Tech",  
ifelse(df$Occupation>=360 & df$Occupation<=365, "Healthcare Support",  
ifelse(df$Occupation>=370 & df$Occupation<=395, "Protective Services",  
ifelse(df$Occupation>=400 & df$Occupation<=416, "Food Prep/Serving",  
ifelse(df$Occupation>=420 & df$Occupation<=425, "Building/Grounds Maintenance",  
ifelse(df$Occupation>=430 & df$Occupation<=465, "Personal Care/Service",  
ifelse(df$Occupation>=470 & df$Occupation<=496, "Sales",  
ifelse(df$Occupation>=500 & df$Occupation<=593, "Office/Admin Support",  
ifelse(df$Occupation>=600 & df$Occupation<=613, "Farming/Fishing/Forestry",  
ifelse(df$Occupation>=620 & df$Occupation<=694, "Construction/Extraction",  
ifelse(df$Occupation>=700 & df$Occupation<=762, "Installation/Maintenance/Repair",  
ifelse(df$Occupation>=770 & df$Occupation<=896, "Production Operations",  
ifelse(df$Occupation>=900 & df$Occupation<=975, "Transportation/Material Moving",  
ifelse(df$Occupation>=980 & df$Occupation<=983, "Military",  
ifelse(df$Occupation==615, "Wild Code",  
ifelse(df$Occupation==999, "DK/NA/R",  
ifelse(df$Occupation==0, "Inap", NA)))))))))))))))))))))))))))

df$Occupation <- as.factor(df$Occupation)

df <- droplevels(df)

```

#Create Serious and moderate mental illness variables and exploitation variable
```{r}

df <- df %>% filter(TotalLaborIncome < quantile(TotalLaborIncome, 0.99, na.rm=TRUE) &  EmployedNow==1 & RelationToHead==10) 


df$SMI <- ifelse(df$K6.Head>=13 & df$K6.Head!=99, 1, ifelse(!is.na(df$K6.Head), 0, NA))
df$MMI <- ifelse(df$K6.Head>=5 & df$K6.Head<13 & df$K6.Head!=99, 1, ifelse(!is.na(df$K6.Head), 0, NA))



df$HourlyWage40 <- ifelse(df$WorkHrs>=2080 , (df$TotalLaborIncome)/2080, NA)

df$TrueHourlyWage <- ifelse(df$WorkHrs>=2080, (df$TotalLaborIncome)/(df$WorkHrs), NA)

df$Exploitation <- (df$HourlyWage40 - df$TrueHourlyWage) / df$HourlyWage40

```



# CODING EXAMPLES FOR SARA

## Get the first mention of variable

```{r}

df$AgeDrEmotProb.Head <- ifelse(df$AgeDrEmotProb.Head==0, NA, df$AgeDrEmotProb.Head)

df <- df %>% group_by(ID) %>% 
  mutate(AgeDrEmotProb.Head.baseline = first(na.omit(AgeDrEmotProb.Head)))

df[,c("Year", "ID", "AgeDrEmotProb.Head", "AgeDrEmotProb.Head.baseline")]

#Surprisingly, a bunch of people change their answers -- but I think first mention is fine. 

```

## If ever endorsed, positive

```{r}
table(df$DrEmotProb.Head)

df <- df %>% group_by(ID) %>% 
  mutate(DrEmotProb.ever = any(DrEmotProb.Head==1))

df[,c("Year", "ID", "DrEmotProb.Head", "DrEmotProb.ever")]
```

