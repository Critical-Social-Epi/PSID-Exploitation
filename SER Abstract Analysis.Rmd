---
title: "SER Abstract Analysis - Heads of Household Only"
output: html_notebook
---

```{r, setup}
library(tidyverse)
library(magrittr)
load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/AnalysisData.Rdata")

```

#Restrict data to heads of household (since only they are asked K6)
```{r}

df <- AnalysisData %>% 
                    select(-contains(".Spouse")) %>% 
                    filter(RelationToHead==10)
```

#For every respondent from 2003-2015 (when K6 asked), go back as far as their first year of participation
```{r}
UniqueIDs <- df %>% filter(Year %in% c("2003", "2005", "2007", "2009", "2011", "2013", "2015"))
UniqueIDs <- unique(UniqueIDs$ID)
df <- df %>% filter(ID %in% UniqueIDs)
df$ID<-as.factor(df$ID)

df %>% group_by(Year) %>% summarize(max(Age.Head, na.rm=TRUE))

quantile(df$AgeDrEmotProb.Head, probs=seq(0,1,0.01), na.rm=TRUE)
table(df$AgeDrEmotProb.Head)

table(df$DrEmotProb.Head)
table(df$AgeDrEmotProb.Head>0)
```



#Check variable value options for Qs asked every year
```{r}
# Recode Age

df$Year <- as.numeric(df$Year)

df <- df %>% mutate(Age.Head = ifelse(Year %in% c(1983:1993) & Age.Head>98, NA, ifelse(Year %in% c(1994:1996) &
                                  Age.Head %in% c(0,98,99), NA, ifelse(Year %in% c(1997:2015) & Age.Head > 120, NA,
                                  Age.Head))))
                    
                    
                    
                    
                    
                


#For Dr



df$AgeDrEmotProb.Head<-ifelse(df$AgeDrEmotProb.Head>0, df$AgeDrEmotProb.Head, NA)
df$AgeDrLearnDisord.Head<-ifelse(df$AgeDrLearnDisord.Head>0, df$AgeDrLearnDisord.Head, NA)
df$ConditionPsych.Head <-ifelse(df$ConditionPysch.Head %in% c(1:9), df$ConditionPysch.Head, NA)
df$Depressed17.Head<-ifelse(df$Depressed17.Head ==1, 1, ifelse(df$Depressed17.Head ==5,0, NA))
df$DrugProb17.Head <- ifelse(df$DrugProb17.Head ==1, 1, ifelse(df$DrugProb17.Head ==5, 0, NA))
df$DrEmotProb.Head<-ifelse(df$DrEmotProb.Head ==1, 1, ifelse(df$DrEmotProb.Head ==5, 0, NA))
df$DrLearnDisord.Head<-ifelse(df$DrLearnDisord.Head ==1, 1, ifelse(df$DrLearnDisord.Head ==5, 0, NA))
df$DrMemLoss.Head<-ifelse(df$DrMemLoss.Head ==1, 1, ifelse(df$DrMemLoss.Head ==5, 0, NA))
df$EmotProb.Head<-ifelse(df$EmotProb.Head ==1, 1, ifelse(df$EmotProb.Head ==5, 0, NA))
df$EmployedNow <- ifelse(df$EmployedNow1.Head %in% df$EmployedNow2.Head %in% (1:8) & Year %in% (1999:2015), df$EmployedNow2.Head, NA)

df$GradesCompl <- ifelse(df$GradesCompl %in% c(1:17), df$GradesCompl, NA)
df$Medicaid <- ifelse(df$Medicaid==9, NA, df$Medicaid)
#df$RelationToHead <- ifelse(df$RelationToHead %in% c(10, 20,22,90), df$RelationToHead, NA)
df$DrinksPerDay <- ifelse(df$DrinksPerDay %in% c(1:25), df$DrinksPerDay, NA)
df$Drink5 <- ifelse(df$Drink5 %in% c(1:365), df$Drink5, NA)

df$EverJob <- ifelse(df$EverJob %in% c(1,5), df$EverJob, NA)
df$EverSmoked <- ifelse(df$EverSmoked %in% c(1,5), df$EverSmoked, NA)
df$GenHealth <- ifelse(df$GenHealth %in% c(1:5), df$GenHealth, NA)
df$Industry <- ifelse(df$Industry != 999 & df$Industry != 0, df$Industry, NA)
df$KidHealth <- ifelse(df$KidHealth %in% c(1:5), df$KidHealth, NA)
df$Occupation <- ifelse(df$Occupation != 998 & df$Occupation!=999 & df$Occupation!=0, df$Occupation, NA)

df$Race.Head <- ifelse(df$Race.Head %in% c(1:7), df$Race, NA)
## this SUCKS but I'm recoding race as Black/White/Other because of changes to how they measured this over time. We can discuss if we want to do it differently, but early questions grouped race/ethnicity and later questions disaggregated them, but Black/White are always asked consistently; the good (?) news is that most of PSID is White or Black
#1 is white, 2 is black, 3 is other
df$Race<-ifelse(df$Race %in% c(1:2), df$Race, ifelse(df$Race %in% c(3:7), 3, NA))

df$SelfEmp <- ifelse(df$SelfEmp %in% c(1:3), df$SelfEmp, NA)
df$TotalLaborIncome <- ifelse(df$TotalLaborIncome >0, df$TotalLaborIncome, NA)
df$UnionCovered <- ifelse(df$UnionCovered %in% c(1,5), df$UnionCovered, NA)
df$WorkHrs <- ifelse(df$WorkHrs > 0 , df$WorkHrs, NA)
df$YearsWorked <- ifelse(df$YearsWorked>0 & df$YearsWorked<98, df$YearsWorked, NA)

df$K6.Head <- ifelse(df$K6.Head<99, df$K6.Head, NA)


## recoding variables for "first mention" to avoid reporting inconsistencies
df<- df %>% group_by(ID) %>% mutate(
  AgeDrEmotProb.Head = dplyr::first(na.omit(AgeDrEmotProb.Head)),
  Race = dplyr::first(na.omit(Race)),
  AgeDrLearnDisord.Head = dplyr::first(na.omit(AgeDrLearnDisord.Head)),
  Depressed17.Head = dplyr::first(na.omit(Depressed17.Head)),
  DrugProb17.Head = dplyr::first(na.omit(DrugProb17.Head)),
  EmotProb.Head = dplyr::first(na.omit(EmotProb.Head))

  %>% mutate(
  (DrEmotProb.Head = dplyr::max(DrEmotProb.Head)),
  (DrLearnDisord.Head = dplyr::max(DrLearnDisord.Head)),
  (DrMemLoss.Head = dplyr::max(DrMemLoss.Head))
  
  ))




```

#Recode industries and occupations into standard groups, 1970s codes and 2000s codes, collapse into one variable

```{r}

df <- df %>% filter(Year %in% c(2003, 2005, 2007, 2009, 2011, 2013, 2015))
df$Industry <- as.numeric(df$Industry)

df$Industry <-
ifelse(df$Industry>=17 & df$Industry<=29, "Agra/Forest/Fish/Hunt",
ifelse(df$Industry>=37 & df$Industry<=49, "Mining",
ifelse(df$Industry>=57 & df$Industry<=69, "Utilities",
ifelse(df$Industry==77, "Construction",
ifelse(df$Industry>=107 & df$Industry<=399, "Manufacturing",
ifelse(df$Industry>=407 & df$Industry<=459, "Wholesale Trade",
ifelse(df$Industry>=467 & df$Industry<=579, "Retail Trade",
ifelse(df$Industry>=607 & df$Industry<=639, "Transport/Warehousing",
ifelse(df$Industry>=647 & df$Industry<=679, "Information",
ifelse(df$Industry>=687 & df$Industry<=699, "Finance and Insurance",
ifelse(df$Industry>=707 & df$Industry<=719, "Real Estate",
ifelse(df$Industry>=727 & df$Industry<=749, "Pro/Sci/Tech Services",
ifelse(df$Industry>=757 & df$Industry<=779, "Management/Admin&Support/Waste Management",
ifelse(df$Industry>=786 & df$Industry<=789, "Educational Services",
ifelse(df$Industry>=797 & df$Industry<=847, "Health Care/Soc Assistance",
ifelse(df$Industry>=856 & df$Industry<=859, "Arts/Ent/Rec",
ifelse(df$Industry>=866 & df$Industry<=869, "Accomm/Food Services",
ifelse(df$Industry>=877 & df$Industry<=929, "Other Services",
ifelse(df$Industry>=937 & df$Industry<=959, "Public Administration",
ifelse(df$Industry==999, "DK/NA/R",
ifelse(df$Industry==0, "Inap", NA)))))))))))))))))))))

df$Industry <-as.factor(df$Industry)


df$Occupation <- as.numeric(df$Occupation)

df$Occupation<-ifelse(df$Occupation>=1 & df$Occupation<=43, "Management",  
ifelse(df$Occupation>=50 & df$Occupation<=73, "Business Operations Specialists",  
ifelse(df$Occupation>=80 & df$Occupation<= 95, "Financial Specialists",  
ifelse(df$Occupation>=100 & df$Occupation<=124, "Computer/Mathematical",  
ifelse(df$Occupation>=130 & df$Occupation<=156, "Architecture/Engineering",  
ifelse(df$Occupation>=160 & df$Occupation<=196, "Life, Phys, Soc Sciences",  
ifelse(df$Occupation>=200 & df$Occupation<=206, "Community/Soc Services",  
ifelse(df$Occupation>=210 & df$Occupation<=215, "Legal",  
ifelse(df$Occupation>=220 & df$Occupation<=255, "Education, Training, and Library",  
ifelse(df$Occupation>=260 & df$Occupation<=296, "Arts/Entertainment",  
ifelse(df$Occupation>=300 & df$Occupation<=354, "Healthcare Practitioner/Tech",  
ifelse(df$Occupation>=360 & df$Occupation<=365, "Healthcare Support",  
ifelse(df$Occupation>=370 & df$Occupation<=395, "Protective Services",  
ifelse(df$Occupation>=400 & df$Occupation<=416, "Food Prep/Serving",  
ifelse(df$Occupation>=420 & df$Occupation<=425, "Building/Grounds Maintenance",  
ifelse(df$Occupation>=430 & df$Occupation<=465, "Personal Care/Service",  
ifelse(df$Occupation>=470 & df$Occupation<=496, "Sales",  
ifelse(df$Occupation>=500 & df$Occupation<=593, "Office/Admin Support",  
ifelse(df$Occupation>=600 & df$Occupation<=613, "Farming/Fishing/Forestry",  
ifelse(df$Occupation>=620 & df$Occupation<=694, "Construction/Extraction",  
ifelse(df$Occupation>=700 & df$Occupation<=762, "Installation/Maintenance/Repair",  
ifelse(df$Occupation>=770 & df$Occupation<=896, "Production Operations",  
ifelse(df$Occupation>=900 & df$Occupation<=975, "Transportation/Material Moving",  
ifelse(df$Occupation>=980 & df$Occupation<=983, "Military",  
ifelse(df$Occupation==615, "Wild Code",  
ifelse(df$Occupation==999, "DK/NA/R",  
ifelse(df$Occupation==0, "Inap", NA)))))))))))))))))))))))))))

df$Occupation <- as.factor(df$Occupation)

df <- droplevels(df)

```

#Create Serious and moderate mental illness variables and exploitation variable
```{r}

df <- df %>% filter(TotalLaborIncome < quantile(TotalLaborIncome, 0.99, na.rm=TRUE) &  EmployedNow==1 & RelationToHead==10) 


df$SMI <- ifelse(df$K6.Head>=13 & df$K6.Head!=99, 1, ifelse(!is.na(df$K6.Head), 0, NA))
df$MMI <- ifelse(df$K6.Head>=5 & df$K6.Head<13 & df$K6.Head!=99, 1, ifelse(!is.na(df$K6.Head), 0, NA))



df$HourlyWage40 <- ifelse(df$WorkHrs>=2080 , (df$TotalLaborIncome)/2080, NA)

df$TrueHourlyWage <- ifelse(df$WorkHrs>=2080, (df$TotalLaborIncome)/(df$WorkHrs), NA)

df$Exploitation <- (df$HourlyWage40 - df$TrueHourlyWage) / df$HourlyWage40

```



#MI
##Create lagged vars

