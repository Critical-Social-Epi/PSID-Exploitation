---
title: "Exploitation IPW-MSM"
output: html_notebook
---



```{r}

library(tidyverse)
library(lme4)
library(broom.mixed)

load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/IPW_MSM_AnalysisData.RData")

df <- IPW_MSM_AnalysisData 

df <- df %>% 
  group_by(ID) %>% 
  mutate(SMI_L = lag(SMI),
         MMI_L = lag(MMI),
         Exploitation_L = lag(Exploitation),
         K6_L = lag(K6),
         WorkHrs_L = lag(WorkHrs))
df <- ungroup(df)

df <- filter(df, TotalLaborIncome>0, EmploymentStatus=="Working")

df <- droplevels(df)

df <- df %>% mutate(Exploit_cat = as.factor(ntile(Exploitation, 20)))

df <- df %>% mutate(Exploitation_bin = if_else(Exploitation <= quantile(Exploitation, 0.6), 0, 1))


df[,c("SMI", "MMI", "Sex")] <- lapply(df[,c("SMI", "MMI",  "Sex")], as.factor)

str(as.ordered(df$Exploit_cat))

```


# Create IPW Weights

## Denominator weights

```{r}

library(ordinal)
library(MASS)

denom.model <- polr(as.ordered(Exploit_cat) ~ Exploitation_L + Sex + Race_cat + Year + FamilySize + GradesCompl + OwnRent +  Occupation_Cat + N_Change_Occupation_Prior + Occupation_Baseline + Depressed17 + DrugProb17 + EmotProb + KidHealth + Depressed.baseline + DrugProb.baseline + EmotProb.baseline + KidHealth.baseline + AlcFreq + DrinksPerDay + EverSmoked + Baseline_Mean_Fam_Size + GenHealth + GenHealth.baseline + InterestIncome + InterestIncome.baseline + OwnRent.baseline + SpouseIncome + SpouseIncome.baseline + UnionCovered + Yrs_Union_Cov + YearsWorked + YearsWorked.baseline + Exploit_Baseline + TotalLaborIncome.baseline + TotalLaborIncome + K6, data=df, Hess = TRUE, na.action = na.omit)

summary(denom.model)

```



```{r}


ND <- crossing(denom.model$model[,-1])

p.denom <- predict(denom.model, ND, type="prob")

denom <- predict(denom.model, type="probs")

p.denom <- p.denom$cprob1 - p.denom$cprob2

cbind(df[,c("ID", "Exploit_cat")], denom)


df$WeightDenom <- p.denom


df$StabilizedWeight <- (1/20)/df$WeightDenom

summary(df$StabilizedWeight)

quantile(df$StabilizedWeight, p=seq(0,1,0.01), na.rm = TRUE)

df <- df %>% mutate(TruncWeight = case_when(
  StabilizedWeight > quantile(StabilizedWeight, 0.935, na.rm=TRUE) ~ quantile(StabilizedWeight, 0.935, na.rm=TRUE)
))

summary(df$TruncWeight)



#denominator is test$cprob1 - test$cprob2
#Assign denominator to each person -- create variable ifelse(Expoitation = 1, )



6.551343e-06	

```

##Numerator model
```{r}
numer.model <- glm(Exploitation_bin ~  Sex + Race, data=df, family=binomial)

p.numer <- predict(numer.model, type = "response")

```



##Weights
```{r}


denom <- ifelse(df$Exploitation_bin == 0, 1-p.denom, p.denom)

df$W_CausExpos <- p.denom/denom

summary(df$W_CausExpos)

quantile(denom, probs=seq(0,1,.1))

df$SW_CausalExposed <- ifelse(df$W_CausExpos > 0.99, 0.99, df$W_CausExpos)

summary(df$SW_CausalExposed)

```





## Numerator weights contin

```{r}

baseline_vars <- c(str_subset(names(df), "baseline"), str_subset(names(df), "Baseline"))

numer.model <- lm(as.formula(paste("Exploitation ~ Sex + Race + Exploitation_L + Year +", paste(baseline_vars, collapse = "+"))), data=df)

p.numer <- predict(numer.model, type = "response")
dens.numer <- dnorm(df$Exploitation, p.numer, summary(numer.model)$sigma)

```



## Weights
```{r}
df$weights <- dens.numer/dens.denom

summary(df$weights, na.rm = TRUE)

quantile(df$weights, p=seq(0,1,.1), na.rm = TRUE)

df$st_weights <- ifelse(df$weights >  quantile(df$weights, 0.6, na.rm=TRUE), quantile(df$weights, 0.6, na.rm=TRUE), df$weights)


summary(df$st_weights)


```


#MSM - SMI

```{r}

library(geepack)


m1 <- geeglm(SMI ~ Exploitation_bin + Race + Sex, data = df, corstr = "exchangeable", weights = W_CausExpos, family="binomial", id=ID)

summary(m1)

```


# MSM - MMI

```{r}
m2 <- geeglm(MMI ~ Exploitation_bin + Race + Sex, data = df, corstr = "exchangeable", weights = W_CausExpos, family="binomial", id=ID)

summary(m2)
```


# Regular models

## Confounder assumptions
```{r}
library(broom)

df_Exp_Conf <- df %>% select(ID:WorkHrs.baseline, Race, SMI, MMI, -EmploymentStatus, -DrMemLoss)

df_nested_Outcome <- df_Exp_Conf %>% gather(key=Confounder, value=E.Val, -ID, -SMI, -MMI)

df_nested_Outcome <- df_nested_Outcome %>% gather(key=Outcome, value=O.Val, SMI, MMI)

df_nested <- df_nested_Outcome %>% group_by(Confounder, Outcome) %>% nest()

(df_nested <- df_nested %>%
  mutate(model = map(data, ~glm(O.Val ~ E.Val, data = ., family=binomial)),
          Model_Tables = map(model, broom::tidy)))

df_nested %>% unnest(Model_Tables, .drop = T)

```

# Fixed Effects

```{r}
m1 <- glm(SMI ~ Exploitation_L + FamilySize + GradesCompl + OwnRent + Industry_Cat + Occupation_Cat + AlcFreq + DrinksPerDay + GenHealth  + InterestIncome +  SpouseIncome  + UnionCovered + ID + Year, data=df, family=binomial)

m2 <- glm(MMI ~ Exploitation_L + FamilySize + GradesCompl + OwnRent + Industry_Cat + Occupation_Cat + AlcFreq + DrinksPerDay + GenHealth  + InterestIncome +  SpouseIncome  + UnionCovered + ID + Year, data=df, family=binomial)

```



```{r}

library(lme4)


m1  <- glmer(SMI ~ Exploitation_L + Sex + Race + Year + FamilySize + GradesCompl + OwnRent + Industry_Cat + N_Change_Industry_Prior + Industry_Baseline + Occupation_Cat + N_Change_Occupation_Prior + Occupation_Baseline + Depressed17 + DrugProb17 + EmotProb + KidHealth + Depressed.baseline + DrugProb.baseline + EmotProb.baseline + KidHealth.baseline + AlcFreq + DrinksPerDay + DrEmotProb + DrLearnDisord + DrMemLoss + EverSmoked + Baseline_Mean_Fam_Size + GenHealth  + InterestIncome + InterestIncome.baseline + OwnRent.baseline  + TotalLaborIncome.baseline  + SpouseIncome + SpouseIncome.baseline + UnionCovered + Yrs_Union_Cov + YearsWorked + YearsWorked.baseline + Exploit_Baseline + (1|ID), data=df, family=binomial)







m3 <- glmer(MMI ~ Exploitation_L + Sex + Race + Year + FamilySize + GradesCompl + OwnRent + Industry_Cat + N_Change_Industry_Prior + Industry_Baseline + Occupation_Cat + N_Change_Occupation_Prior + Occupation_Baseline + Depressed17 + DrugProb17 + EmotProb + KidHealth + Depressed.baseline + DrugProb.baseline + EmotProb.baseline + KidHealth.baseline + AlcFreq + DrinksPerDay + DrEmotProb + DrLearnDisord + DrMemLoss + EverSmoked + Baseline_Mean_Fam_Size + GenHealth  + InterestIncome + InterestIncome.baseline + OwnRent.baseline  + TotalLaborIncome.baseline  + SpouseIncome + SpouseIncome.baseline + UnionCovered + Yrs_Union_Cov + YearsWorked + YearsWorked.baseline + Exploit_Baseline + (1|ID), data=df, family=binomial)







df[,sapply(df, is.numeric)] <- lapply(df[,sapply(df, is.numeric)], scale, center=TRUE, scale=TRUE)


df <- df %>% 
  group_by(ID) %>% 
  mutate(SMI_L = lag(SMI),
         MMI_L = lag(MMI),
         Exploitation_L = lag(Exploitation))
df <- ungroup(df)



m1  <- glmer(SMI ~ Exploitation_L + Sex + Race + Year + FamilySize + GradesCompl + OwnRent + Occupation_Cat + N_Change_Occupation_Prior + Occupation_Baseline + Depressed17 + DrugProb17 + EmotProb + KidHealth + Depressed.baseline + DrugProb.baseline + EmotProb.baseline + KidHealth.baseline + AlcFreq + DrinksPerDay + DrEmotProb + DrLearnDisord + DrMemLoss + EverSmoked + Baseline_Mean_Fam_Size + GenHealth  + InterestIncome + InterestIncome.baseline + OwnRent.baseline  + TotalLaborIncome.baseline  + SpouseIncome + SpouseIncome.baseline + UnionCovered + Yrs_Union_Cov + YearsWorked + YearsWorked.baseline + Exploit_Baseline + (1|ID), data=df, family=binomial)


m1  <- glmer(SMI ~ Exploitation_L + Sex + Race + Year  + GradesCompl + OwnRent + Occupation_Cat + N_Change_Occupation_Prior + Occupation_Baseline + Depressed17 + DrugProb17 + EmotProb + KidHealth + AlcFreq + DrinksPerDay + EverSmoked  +  SpouseIncome  + UnionCovered + Yrs_Union_Cov + YearsWorked   + (1|ID), data=df, family=binomial)

```






# Relationship bw work hours and exploitation

```{r}

df <- df %>% mutate(Exploitation_Z = scale(Exploitation, center=TRUE, scale=TRUE),
                    Exploitation_Z_L = lag(Exploitation_Z),
                    WorkHrs_Z = scale(WorkHrs, center=TRUE, scale=TRUE),
                    WorkHrs_Z_L = lag(WorkHrs_Z))

m1  <- glmer(MMI ~ Exploitation_Z_L + Year  + (1|ID), data=df, family=binomial)
summary(m1)
tidy(m1, exponentiate=TRUE, conf.int=TRUE)


m2  <- glmer(MMI ~ WorkHrs_Z_L + Year +  (1|ID), data=df, family=binomial)
summary(m2)
tidy(m2, exponentiate = TRUE, conf.int=TRUE)


m1  <- glmer(MMI ~ Exploitation_Z_L + Year  + (1|ID), family=binomial)
summary(m1)
tidy(m1, exponentiate=TRUE, conf.int=TRUE)


m2  <- glmer(MMI ~ WorkHrs_Z_L + Year +  (1|ID), data=df, family=binomial)
summary(m2)
tidy(m2, exponentiate = TRUE, conf.int=TRUE)
```

## Plots of relationship bw variables

```{r}

ggplot(df, aes(x = Exploitation, y = WorkHrs)) +
  geom_point()

```


# May 6 Attempt

```{r}

load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")

library(survey)
library(tidyverse)
df <- Full_CleanedData

df <- df %>% mutate(Exploit35_cat = as.factor(ntile(Exploitation35, 20)))

df <- filter(df, WorkHrs >= 1820, RelationToHead == 10)

df <- as.data.frame(df)

df <- df %>% select(-contains("40"))

options(survey.lonely.psu="average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~Individ.Weight, nest = TRUE, data = df)
```

## Quantile binning
```{r}
library(nnet)

model_vars <- df %>% select(Sex, Year, Race_cat, N_Change_Industry_Prior, N_Change_Occupation_Prior, Industry_Baseline, Occupation_Baseline, Depressed.baseline, DrugProb.baseline, EmotProb.baseline, KidHealth.baseline, DrEmotProb.baseline, DrLearnDisord.baseline, EmploymentStatus.baseline, GenHealth.baseline, InterestIncome.baseline, Yrs_Self_Emp, TotalLaborIncome.baseline, SpouseIncome.baseline, Yrs_Union_Cov,  YearsWorked.baseline WorkHrs.baseline, ExtraJobIncomeBaseline, Annual.OT.Hrs.Baseline, OT.Income.Baseline,
Yrs.Extra.Job, Total.Jobs.Baseline, Hrs.Extra.Jobs.Baseline, Hrs.When.Empl.Baseline, NumXtraJobsUnemp.base, HrsXtraJobsUnemp.base,  )

denom.mod <- multinom(Exploit35_cat ~ Exploitation35_L + 
                                      
                        data=df, weights = Individ.Weight)
summary(m2)

ND <- crossing(m2$model[,-1])
  
test <- predict(m2, ND, type="prob")  



p.denom <- predict(denom.model, ND, type="prob")
  
  
  
  predicted_prior= rep(0,nrow(yourdata))
  
  predictmult2 =predict(mult2, type = "p")
  
  for(j in 1:nrow(yourdata)){
    predicted_prior[j]= predictmult2[j,which(colnames(predictmult2)==yourdata$exposure[j])]
  }
  
  predicted_prob= rep(0,nrow(yourdata))
  predictmult1 =predict(mult1, type = "p")
  
  for(j in 1:nrow(BZx)){
    predicted_prob[j]= predictmult1[j,which(colnames(predictmult1)==yourdata$exposure[j])]
  }
  
ipwQB= predicted_prior/predicted_prob
    
  return(ipwQB)
}

```


## Gamma model

```{r}



gammamod <- svyglm(Exploitation35 ~ Sex, family=Gamma(link="log"), svy_obj)
  
  x= yourdata$continuousexposure
  
  scalex= gamma.shape(gammamod)$alpha
  
  xb= predict(gammamod, type="response")
  
  lambda= xb/scalex
  
  denominator= dgamma(x, scale= lambda, shape=rep(scalex,100))
  
  gammamod2= glm(continuousexposure ~ 
                    time fixed confounder 1 
                  + time fixed confounder 2 
                  +  … 
                  + time fixed confounder N 
                    , data=yourdata, family=Gamma(link="log"))
  
  x2= yourdata$continuousexposure
  
  scalex2= gamma.shape(gammamod2)$alpha
   xb2= predict(gammamod2, type="response")
  lambda2= xb2/scalex2
  
  numerator= dgamma(x2, scale= lambda2, shape=rep(scalex2,100))
  weightgamma= numerator/denominator

  return(weightgamma)
}

```

