---
title: "Exploitation IPW-MSM"
output: html_notebook
---

# Setup

```{r}

load("/Users/SJP1/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")
library(rio)
library(survey)
library(tidyverse)
library(geepack)
library(broom)
df <- as.data.frame(Full_CleanedData)

df <- df %>% mutate(
              Exploitation40_L = lag(Exploitation40),
              Exploit40_cat = as.factor(ntile(Exploitation40, 10)),
              Sex = as.factor(Sex),
              Exploitation40_0 = ifelse(Exploitation40 < quantile(Exploitation40, 0.1, na.rm = TRUE), quantile(Exploitation40, 0.1, na.rm = TRUE), Exploitation40),
              Exploit40_0_cat = as.factor(ntile(Exploitation40_0, 10)),
              Exploitation40_0_L = lag(Exploitation40_0))

df <- as.data.frame(df)
```


# Confounder selection

```{r, eval=FALSE}
cs <- df %>% select(-contains("_L"), -contains("MI_TV"), -GenHealth_TV, -GenHealth.Base, -RelationToHead, -Individ.Weight, -SampErrClust_cume, -SampErrStrat_cume, -Sex_cume, -Year_cume, -K6_TV_cume, -RelationToHead_cume, -Age_cume, -Top_1_Percent_cume, -Exploitation40_cume, -Exploitation40_cume, - Extra.Job_TV,  -SpouseIncome, -Annual.OT.Hrs.Base, -Exploitation40,  -Individ.Weight_cume, -Exploit40_cat, -ID, -SampErrClust, -SampErrStrat, -K6_TV, -Top_1_Percent,  -DrLearnDisord.Base, -DrEmotProb.Base, -Exploitation40, -SMI_TV, -MMI_TV)

confounders <- names(cs)
exposure <- rep("Exploitation40 ~", length(confounders))
outcomes <- rep(c("MMI_TV ~", "SMI_TV ~"), each=length(confounders))

C_E <- Map(function(a,b) lm(as.formula(paste(list(a), paste(list(b), collapse="+"))), data=df), exposure, confounders )


C_E_df <- lapply(C_E, tidy)
C_E_df <- bind_rows(C_E_df)
NS_C_E_df <- C_E_df %>% filter(term != "(Intercept)", p.value > 0.05) 

not_sig <- df %>% select(-OT.Hrs.Main.Job, -N_Change_Industry_Base, -DrMemLoss.Base, -InterestIncome_TV, -ExtraJobIncome.Base, -OT.Income.Base, -OT.Hrs.Main.Job_cume, -SpouseIncome_cume, -SpouseIncome_TV_cume)

C_O <- Map(function(a,b) glm(as.formula(paste(list(a), paste(list(b), collapse="+"))), data=df, family="quasibinomial"), outcomes, confounders )

C_O_df <- lapply(C_O, tidy)
C_O_df <- bind_rows(C_O_df)
NS_C_O_df <- C_E_df %>% filter(term != "(Intercept)", p.value < 0.05) 

not_sig2 <- df %>% select(-OT.Hrs.Main.Job, -ExtraJobIncome.Base, -OT.Income.Base, -OT.Hrs.Main.Job_cume, -SpouseIncome_cume, -SpouseIncome_TV_cume)

```



```{r}

#vars_to_exclude <- unique(c("GenHealth_TV", "GenHealth.Base", "RelationToHead",  "SampErrClust_cume", "SampErrStrat_cume", "Sex_cume", "Year_cume", "K6_TV_cume", "RelationToHead_cume", "Age_cume", "Top_1_Percent_cume", "Exploitation40_cume", "Exploitation40_cume", "Extra.Job_TV", "SpouseIncome", "Annual.OT.Hrs.Base", "Exploitation40", "Individ.Weight_cume", "DrLearnDisord.Base", "DrEmotProb.Base", "Exploitation40",  "OT.Hrs.Main.Job", "N_Change_Industry_Base", "DrMemLoss.Base", "InterestIncome_TV", "ExtraJobIncome.Base", "OT.Income", "OT.Hrs.Main.Job_cume", "SpouseIncome_cume", "SpouseIncome_TV_cume", "OT.Hrs.Main.Job", "ExtraJobIncome.Base", "OT.Income.Base", "OT.Hrs.Main.Job_cume", "SpouseIncome_cume",  "SpouseIncome_TV_cume"))


df <- df %>%
  select(-contains("GenHealth_TV"), -contains("GenHealth.Base"), -contains("RelationToHead"),  -contains("SampErrClust_cume"), -contains("SampErrStrat_cume"), -contains("Sex_cume"), -contains("Year_cume"), -contains("K6_TV_cume"), -contains("RelationToHead_cume"), -contains("Age_cume"), -contains("Top_1_Percent_cume"), -contains("Exploitation40_cume"), -contains("Exploitation40_cume"), -contains("Extra.Job_TV"),  -contains("Annual.OT.Hrs.Base"), -contains("Individ.Weight_cume"), -contains("DrLearnDisord.Base"), -contains("DrEmotProb.Base"),  -contains("OT.Hrs.Main.Job"), -contains("N_Change_Industry_Base"), -contains("DrMemLoss.Base"), -contains("InterestIncome_TV"), -contains("ExtraJobIncome.Base"), -contains("OT.Income.Base"), -contains("OT.Hrs.Main.Job_cume"), -contains("SpouseIncome_cume"), -contains("SpouseIncome_TV_cume"), -contains("OT.Hrs.Main.Job"), -contains("ExtraJobIncome.Base"), -contains("OT.Income.Base"), -contains("OT.Hrs.Main.Job_cume"), -contains("SpouseIncome_cume"),  -contains("SpouseIncome_TV_cume"), -contains("35")) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(Year = as.factor(Year))


df <- droplevels(df)

#options(survey.lonely.psu="average")
#svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~Individ.Weight, nest = TRUE, data = df)
```

any disorder versus none
use the top 1% nationally rather then sample


# Quantile binning

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ","))

time_var <- df %>% select(contains("_L"), Year, -SpouseIncome, -Top_1_Percent_L, -K6_TV_L, -Age_L, -SpouseIncome_L, -SMI_TV_L, -MMI_TV_L,  -FamilyComp_cume_L, -TotalLaborIncome_TV_cume_L, -FamilySize_TV_cume_L, -TotalLaborIncome_TV_L, -WorkHrs_TV_L, -Exploitation40, -Exploit40_cat, -Exploitation40_0, -Exploitation40_0_L)
time_var <- names(time_var)

baseline_vars_numer <- df %>% select(contains("Base")) #
baseline_vars_numer <- c("Sex", "Race_cat", paste(names(baseline_vars_numer), sep = ","))

```

## Create IP treatment weights 

```{r}

library(nnet)

denom.formula <- as.formula(c(paste("Exploit40_cat ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- multinom(denom.formula, data = df, weights = Individ.Weight, MaxNWts = 6000, maxit = 2000)

numer.formula <- as.formula(paste(paste("Exploit40_cat ~ Exploitation40_L"), paste(baseline_vars_numer, collapse = " + "), sep = "+"))

numer.mod <- multinom(numer.formula, data = df, weights = Individ.Weight, MaxNWts = 6000, maxit = 2000)


pred.denom <- as.data.frame(predict(denom.mod, newdata = df, type = "prob"))
pred.numer <- as.data.frame(predict(numer.mod, newdata = df, type = "prob"))

df1 <- df %>%
  mutate(
    iptw.numerator = pred.numer[cbind(seq_len(nrow(pred.numer)), match(pred.numer$Exploit40_cat, colnames(pred.numer)))],
    iptw.denominator = pred.denom[cbind(seq_len(nrow(pred.denom)), match(pred.denom$Exploit40_cat, colnames(pred.denom)))],
    iptw = iptw.numerator / iptw.denominator,
    iptw.trunc = ifelse(iptw < quantile(iptw, 0.1, na.rm = TRUE), quantile(iptw, 0.1, na.rm = TRUE), ifelse(iptw > quantile(iptw, 0.99, na.rm = TRUE), quantile(iptw, 0.99, na.rm = TRUE), iptw))
  ) 


#quantile(df1$iptw.trunc, seq(0,1,.01), na.rm=TRUE)
#summary(df1$iptw.trunc)

#df1 %>% group_by(Year) %>% 
#  summarise(mean(iptw.trunc, na.rm=TRUE))

summary(df1$iptw.trunc)
```


## Choose variables for IP censoring weights

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

Cens_df <- df1 %>% select(ID:Year, Age, Exploitation40, Exploit40_cat, contains("Base"), -contains("_L"), -contains("SMI"), -contains("MMI"), -K6_TV_L, -FamilyComp)

baseline_vars <- Cens_df %>% select(contains("Base"), -Yrs_Self_Emp_Base, -Yrs.Extra.Job_Base, -OwnRent.Base)
baseline_vars <- c("Sex", paste(names(baseline_vars), sep = ","))

time_var <- df1 %>% select(contains("_TV"), Exploitation40, Occupation_Cat, -contains("Base"), -contains("_L"), -contains("SMI"), -contains("MMI"), -contains("cume"),  -K6_TV, Year) 

time_var <- names(time_var)

 
```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 50))

numer.formula.cens <- as.formula(c(paste(paste("K6_censored ~ "), paste(baseline_vars, collapse = " + "))))

numer.mod.cens <- glm(numer.formula.cens, data = df1, weights = Individ.Weight,  family = "quasibinomial", control = list(maxit = 50))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

```


## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw = iptw*ipcw*Individ.Weight)

```


## MSM

```{r}

df2 <- df2 %>% 
  filter(!is.na(ipw))

options(survey.lonely.psu="average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df2)


MSM <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploitation40_L +"), paste(baseline_vars_numer, collapse = " + ")))), design = svy_obj, maxit=50 )

summary(MSM)


test <- geeglm(as.formula(c(paste(paste("MMI_TV ~ Exploitation40_L +"), paste(baseline_vars_numer, collapse = " + ")))), id=ID, corstr = "exchangeable", data=df2, weights=ipw)

tidy(test)

```





### Debug

```{r}

debug_contr_error <- function (dat, subset_vec = NULL) {
  if (!is.null(subset_vec)) {
    ## step 0
    if (mode(subset_vec) == "logical") {
      if (length(subset_vec) != nrow(dat)) {
        stop("'logical' `subset_vec` provided but length does not match `nrow(dat)`")
        }
      subset_log_vec <- subset_vec
      } else if (mode(subset_vec) == "numeric") {
      ## check range
      ran <- range(subset_vec)
      if (ran[1] < 1 || ran[2] > nrow(dat)) {
        stop("'numeric' `subset_vec` provided but values are out of bound")
        } else {
        subset_log_vec <- logical(nrow(dat))
        subset_log_vec[as.integer(subset_vec)] <- TRUE
        } 
      } else {
      stop("`subset_vec` must be either 'logical' or 'numeric'")
      }
    dat <- base::subset(dat, subset = subset_log_vec)
    } else {
    ## step 1
    dat <- stats::na.omit(dat)
    }
  if (nrow(dat) == 0L) warning("no complete cases")
  ## step 2
  var_mode <- sapply(dat, mode)
  if (any(var_mode %in% c("complex", "raw"))) stop("complex or raw not allowed!")
  var_class <- sapply(dat, class)
  if (any(var_mode[var_class == "AsIs"] %in% c("logical", "character"))) {
    stop("matrix variables with 'AsIs' class must be 'numeric'")
    }
  ind1 <- which(var_mode %in% c("logical", "character"))
  dat[ind1] <- lapply(dat[ind1], as.factor)
  ## step 3
  fctr <- which(sapply(dat, is.factor))
  if (length(fctr) == 0L) warning("no factor variables to summary")
  ind2 <- if (length(ind1) > 0L) fctr[-ind1] else fctr
  dat[ind2] <- lapply(dat[ind2], base::droplevels.factor)
  ## step 4
  lev <- lapply(dat[fctr], base::levels.default)
  nl <- lengths(lev)
  ## return
  list(nlevels = nl, levels = lev)
}

debug_contr_error2 <- function (form, dat, subset_vec = NULL) {
  ## step 0
  if (!is.null(subset_vec)) {
    if (mode(subset_vec) == "logical") {
      if (length(subset_vec) != nrow(dat)) {
        stop("'logical' `subset_vec` provided but length does not match `nrow(dat)`")
        }
      subset_log_vec <- subset_vec
      } else if (mode(subset_vec) == "numeric") {
      ## check range
      ran <- range(subset_vec)
      if (ran[1] < 1 || ran[2] > nrow(dat)) {
        stop("'numeric' `subset_vec` provided but values are out of bound")
        } else {
        subset_log_vec <- logical(nrow(dat))
        subset_log_vec[as.integer(subset_vec)] <- TRUE
        } 
      } else {
      stop("`subset_vec` must be either 'logical' or 'numeric'")
      }
    dat <- base::subset(dat, subset = subset_log_vec)
    }
  ## step 0 and 1
  dat_internal <- stats::lm(form, data = dat, method = "model.frame")
  attr(dat_internal, "terms") <- NULL
  ## rely on `debug_contr_error` for steps 2 to 4
  c(list(mf = dat_internal), debug_contr_error(dat_internal, NULL))
}

debug_contr_error2(form=denom.mod, dat=df1)
```

## Without individual weights
 
 ## Create IP treatment weights 

```{r}

library(nnet)

denom.formula <- as.formula(c(paste("Exploit40_0_cat ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- multinom(denom.formula, data = df, MaxNWts = 6000, maxit = 2000)

numer.formula <- as.formula(paste(paste("Exploit40_0_cat ~ Exploitation40_0_L"), paste(baseline_vars_numer, collapse = " + "), sep = "+"))

numer.mod <- multinom(numer.formula, data = df, MaxNWts = 6000, maxit = 2000)


pred.denom <- as.data.frame(predict(denom.mod, newdata = df, type = "prob"))
pred.numer <- as.data.frame(predict(numer.mod, newdata = df, type = "prob"))

df1 <- df %>%
  mutate(
    iptw.numerator = pred.numer[cbind(seq_len(nrow(pred.numer)), match(pred.numer$Exploit40_cat, colnames(pred.numer)))],
    iptw.denominator = pred.denom[cbind(seq_len(nrow(pred.denom)), match(pred.denom$Exploit40_cat, colnames(pred.denom)))],
    iptw = iptw.numerator / iptw.denominator,
    iptw.trunc = ifelse(iptw < quantile(iptw, 0.1, na.rm = TRUE), quantile(iptw, 0.1, na.rm = TRUE), ifelse(iptw > quantile(iptw, 0.99, na.rm = TRUE), quantile(iptw, 0.99, na.rm = TRUE), iptw))
  ) 


#quantile(df1$iptw.trunc, seq(0,1,.01), na.rm=TRUE)
#summary(df1$iptw.trunc)

#df1 %>% group_by(Year) %>% 
#  summarise(mean(iptw.trunc, na.rm=TRUE))

summary(df1$iptw.trunc)
```


## Choose variables for IP censoring weights

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

Cens_df <- df1 %>% select(ID:Year, Age, Exploitation40, Exploit40_cat, contains("Base"), -contains("_L"), -contains("SMI"), -contains("MMI"), -K6_TV_L, -FamilyComp)

baseline_vars <- Cens_df %>% select(contains("Base"), -Yrs_Self_Emp_Base, -Yrs.Extra.Job_Base, -OwnRent.Base)
baseline_vars <- c("Sex", paste(names(baseline_vars), sep = ","))

time_var <- df1 %>% select(contains("_TV"), Exploitation40, Occupation_Cat, -contains("Base"), -contains("_L"), -contains("SMI"), -contains("MMI"), -contains("cume"),  -K6_TV, Year) 

time_var <- names(time_var)

 
```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, family = "quasibinomial", control = list(maxit = 50))

numer.formula.cens <- as.formula(c(paste(paste("K6_censored ~ "), paste(baseline_vars, collapse = " + "))))

numer.mod.cens <- glm(numer.formula.cens, data = df1,  family = "quasibinomial", control = list(maxit = 50))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

```


## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw = iptw*ipcw*Individ.Weight)

```


## MSM

```{r}

df2 <- df2 %>% 
  filter(!is.na(ipw))

svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df2)


MSM <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploitation40_L +"), paste(baseline_vars_numer, collapse = " + ")))), design = svy_obj, maxit=50 )

summary(MSM)


test <- geeglm(as.formula(c(paste(paste("MMI_TV ~ Exploitation40_L +"), paste(baseline_vars_numer, collapse = " + ")))), id=ID, corstr = "exchangeable", data=df2, weights=ipw)

tidy(test)

```


# Dichotomize at various levels

```{r}
library(tidyverse)
load("/Users/SJP1/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")

#names(df)
```

```{r}
df <- as.data.frame(Full_CleanedData)
df <- df %>% 
  mutate(
         Exploit40_bin_10 = ifelse(Exploitation40 > 0, 1, 0),
         Exploit35_bin_10 = ifelse(Exploitation35 > 0, 1, 0),
         Exploit40_bin_20 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.2, na.rm = TRUE), 1, 0),
         Exploit35_bin_20 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.2, na.rm = TRUE), 1, 0),
         Exploit40_bin_30 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.3, na.rm = TRUE), 1, 0),
         Exploit35_bin_30 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.3, na.rm = TRUE), 1, 0),
         Exploit40_bin_40 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.4, na.rm = TRUE), 1, 0),
         Exploit35_bin_40 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.4, na.rm = TRUE), 1, 0),
         Exploit40_bin_50 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.5, na.rm = TRUE), 1, 0),
         Exploit35_bin_50 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.5, na.rm = TRUE), 1, 0),
         Exploit40_bin_60 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.6, na.rm = TRUE), 1, 0),
         Exploit35_bin_60 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.6, na.rm = TRUE), 1, 0),
         Exploit40_bin_70 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.7, na.rm = TRUE), 1, 0),
         Exploit35_bin_70 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.7, na.rm = TRUE), 1, 0),
         Exploit40_bin_80 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.8, na.rm = TRUE), 1, 0),
         Exploit35_bin_80 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.8, na.rm = TRUE), 1, 0),
         Exploit40_bin_90 = ifelse(Exploitation40 >= quantile(Exploitation40, 0.9, na.rm = TRUE), 1, 0),
         Exploit35_bin_90 = ifelse(Exploitation35 >= quantile(Exploitation35, 0.9, na.rm = TRUE), 1, 0)
         )

#quantile(df$Exploitation40, seq(0,1,.01), na.rm = TRUE)
#table(df$Exploitation40==0)
```

## Toss variables

```{r}
df <- df %>%
  select(-c(GenHealth_TV, GenHealth.Base, RelationToHead,  SampErrClust_cume, SampErrStrat_cume, Sex_cume, Year_cume, K6_TV_cume, RelationToHead_cume, Age_cume, Top_1_Percent_cume, Exploitation40_cume, Exploitation40_cume, Extra.Job_TV, Individ.Weight_cume, DrLearnDisord.Base, DrEmotProb.Base, N_Change_Industry_Base, DrMemLoss.Base, InterestIncome_TV, OT.Hrs.Main.Job_cume, SpouseIncome_cume, SpouseIncome_TV_cume, OT.Hrs.Main.Job, OT.Hrs.Main.Job_cume, SpouseIncome_cume, FamilyComp_cume, FamilySize_TV_cume, OT.Income_TV_cume, WageSal.Head_cume, TotalLaborIncome_TV_cume, WageSal.Head, YearsWorked_TV_cume, OwnRent_TV, SpouseIncome, EmploymentStatus_TV, WorkHrs_TV_cume, Annual.OT.Hrs_TV_cume, GenHealth.Base), -contains("_0"), -contains("cat"), contains("Race_cat"),  -contains("_L"), Exploitation35_L, Occupation_Cat, N_Change_Employ_Base
    ) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(Year = as.factor(Year)) %>% 
  filter(Occupation_Cat != "Military")

df <- droplevels(df)

#df[] <- lapply(df,as.integer)
#cm <- round(cor(df, use="complete.obs"), digits=4)
#write.csv(cm, file="cm.csv")
#names(df)
```

# Dichtomized exposure at 30% exploitation

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"), -c(Industry_Base, OwnRent.Base, DrugProb.Base, EmotProb.Base, KidHealth.Base , SpouseIncome.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ",")) #, Depressed.Base, InterestIncome.Base

time_var <- df %>% select(c("Occupation_Cat", "ConditionPsych_TV", "Annual.OT.Hrs_TV", "YearsWorked_TV", "GradesCompl_TV", "UnionCovered_TV", "Hrly.Slry_TV", "AlcFreq_TV", "TotalLaborIncome_TV" , "Hrly.Slry_TV", "SpouseIncome_TV",  "OT.Income_TV", "Exploitation35_L", "Age"))
time_var <- names(time_var)



```


## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploit35_bin_30 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- glm(denom.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

numer.formula <- as.formula(paste(paste("Exploit35_bin_30 ~ 1"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- glm(numer.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")

pred.numer <- predict(numer.mod, newdata = df, type = "response")


df1 <- df %>%
  mutate(
    ipt_pop_30 = ifelse(Exploit35_bin_30==0,  ((1-pred.numer)/(1-pred.denom)), ((pred.numer)/(pred.denom))),
    ipt_exp_30 = ifelse(Exploit35_bin_30==1, 1, (pred.denom/(1-pred.denom))),
    ipt_pop_30_trunc = ifelse(ipt_pop_30 > quantile(ipt_pop_30, .99, na.rm = T), quantile(ipt_pop_30, .99, na.rm = T), ifelse(ipt_pop_30 < quantile(ipt_pop_30, .01, na.rm = T), quantile(ipt_pop_30, .01, na.rm = T), ipt_pop_30)),
    ipt_exp_30_trunc = ifelse(ipt_exp_30 > quantile(ipt_exp_30, .99, na.rm = T), quantile(ipt_exp_30, .99, na.rm = T), ifelse(ipt_exp_30 < quantile(ipt_exp_30, .01, na.rm = T), quantile(ipt_exp_30, .01, na.rm = T), ipt_exp_30))
  ) 

lapply(df1[,c("ipt_pop_30_trunc", "ipt_exp_30_trunc")], summary)
```

## Create variable for IP censoring of K6

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 50))

numer.formula.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base +
                            ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data=df1,
                            weights=Individ.Weight, family=quasibinomial, maxit=100)

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.formula.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)

```

## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw_exp = ipt_exp_30_trunc*ipcw*Individ.Weight,
                      ipw_pop = ipt_pop_30_trunc*ipcw*Individ.Weight,
                      Exploit35_bin_30 = as.factor(Exploit35_bin_30))

```


## MSM

```{r}
library(survey)

df3 <- df2 %>% 
  filter(!is.na(ipw_exp))

options(survey.lonely.psu="average")
svy_obj_exp <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_exp, nest = TRUE, data = df3)


MSM_exp <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_30 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_exp, maxit=50 )

summary(MSM_exp)

df4 <- df2 %>% 
  filter(!is.na(ipw_pop))

options(survey.lonely.psu="average")
svy_obj_pop <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_pop, nest = TRUE, data = df4)

MSM_pop <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_30 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_pop, maxit=50 )

summary(MSM_pop)

```


# Dichtomized exposure at 40% exploitation

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"), -c(Industry_Base, OwnRent.Base, DrugProb.Base, EmotProb.Base, KidHealth.Base , SpouseIncome.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ",")) #, Depressed.Base, InterestIncome.Base

time_var <- df %>% select(c("Occupation_Cat", "ConditionPsych_TV", "Annual.OT.Hrs_TV", "YearsWorked_TV", "GradesCompl_TV", "UnionCovered_TV", "Hrly.Slry_TV", "AlcFreq_TV", "TotalLaborIncome_TV" , "Hrly.Slry_TV", "SpouseIncome_TV",  "OT.Income_TV", "Exploitation35_L", "Age"))
time_var <- names(time_var)



```


## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploit35_bin_40 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- glm(denom.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

numer.formula <- as.formula(paste(paste("Exploit35_bin_40 ~ 1"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- glm(numer.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")

pred.numer <- predict(numer.mod, newdata = df, type = "response")


df1 <- df %>%
  mutate(
    ipt_pop_40 = ifelse(Exploit35_bin_40==0,  ((1-pred.numer)/(1-pred.denom)), ((pred.numer)/(pred.denom))),
    ipt_exp_40 = ifelse(Exploit35_bin_40==1, 1, (pred.denom/(1-pred.denom))),
    ipt_pop_40_trunc = ifelse(ipt_pop_40 > quantile(ipt_pop_40, .99, na.rm = T), quantile(ipt_pop_40, .99, na.rm = T), ifelse(ipt_pop_40 < quantile(ipt_pop_40, .01, na.rm = T), quantile(ipt_pop_40, .01, na.rm = T), ipt_pop_40)),
    ipt_exp_40_trunc = ifelse(ipt_exp_40 > quantile(ipt_exp_40, .99, na.rm = T), quantile(ipt_exp_40, .99, na.rm = T), ifelse(ipt_exp_40 < quantile(ipt_exp_40, .01, na.rm = T), quantile(ipt_exp_40, .01, na.rm = T), ipt_exp_40))
  ) 

lapply(df1[,c("ipt_pop_40_trunc", "ipt_exp_40_trunc")], summary)
```

## Create variable for IP censoring of K6

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 50))

numer.formula.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +
                            EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base +
                            ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data=df1,
                            weights=Individ.Weight, family=quasibinomial, maxit=100)

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.formula.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)

```

## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw_exp = ipt_exp_40_trunc*ipcw*Individ.Weight,
                      ipw_pop = ipt_pop_40_trunc*ipcw*Individ.Weight,
                      Exploit35_bin_40 = as.factor(Exploit35_bin_40))

```


## MSM

```{r}
library(survey)

df3 <- df2 %>% 
  filter(!is.na(ipw_exp))

options(survey.lonely.psu="average")
svy_obj_exp <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_exp, nest = TRUE, data = df3)


MSM_exp <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_40 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_exp, maxit=50 )

summary(MSM_exp)

df4 <- df2 %>% 
  filter(!is.na(ipw_pop))

options(survey.lonely.psu="average")
svy_obj_pop <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_pop, nest = TRUE, data = df4)

MSM_pop <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_40 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_pop, maxit=50 )

summary(MSM_pop)

```



# Dichtomized exposure at 50% exploitation

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"), -c(Industry_Base, OwnRent.Base, DrugProb.Base, EmotProb.Base, KidHealth.Base , SpouseIncome.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ",")) #, Depressed.Base, InterestIncome.Base

time_var <- df %>% select(c("Occupation_Cat", "ConditionPsych_TV", "Annual.OT.Hrs_TV", "YearsWorked_TV", "GradesCompl_TV", "UnionCovered_TV", "Hrly.Slry_TV", "AlcFreq_TV", "TotalLaborIncome_TV" , "Hrly.Slry_TV", "SpouseIncome_TV",  "OT.Income_TV", "Exploitation35_L", "Age"))
time_var <- names(time_var)



```

## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploit35_bin_50 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- glm(denom.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

numer.formula <- as.formula(paste(paste("Exploit35_bin_50 ~ 1"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- glm(numer.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")

pred.numer <- predict(numer.mod, newdata = df, type = "response")


df1 <- df %>%
  mutate(
    ipt_pop_50 = ifelse(Exploit35_bin_50==0,  ((1-pred.numer)/(1-pred.denom)), ((pred.numer)/(pred.denom))),
    ipt_exp_50 = ifelse(Exploit35_bin_50==1, 1, (pred.denom/(1-pred.denom))),
    ipt_pop_50_trunc = ifelse(ipt_pop_50 > quantile(ipt_pop_50, .99, na.rm = T), quantile(ipt_pop_50, .99, na.rm = T), ifelse(ipt_pop_50 < quantile(ipt_pop_50, .01, na.rm = T), quantile(ipt_pop_50, .01, na.rm = T), ipt_pop_50)),
    ipt_exp_50_trunc = ifelse(ipt_exp_50 > quantile(ipt_exp_50, .99, na.rm = T), quantile(ipt_exp_50, .99, na.rm = T), ifelse(ipt_exp_50 < quantile(ipt_exp_50, .01, na.rm = T), quantile(ipt_exp_50, .01, na.rm = T), ipt_exp_50))
  ) 

lapply(df1[,c("ipt_pop_50_trunc", "ipt_exp_50_trunc")], summary)
```

## Create variable for IP censoring of K6

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 50))

numer.formula.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +
                            EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base +
                            ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data=df1,
                            weights=Individ.Weight, family=quasibinomial, maxit=100)

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.formula.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)

```

## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw_exp = ipt_exp_50_trunc*ipcw*Individ.Weight,
                      ipw_pop = ipt_pop_50_trunc*ipcw*Individ.Weight,
                      Exploit35_bin_50 = as.factor(Exploit35_bin_50))

```


## MSM

```{r}
library(survey)

df3 <- df2 %>% 
  filter(!is.na(ipw_exp))

options(survey.lonely.psu="average")
svy_obj_exp <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_exp, nest = TRUE, data = df3)


MSM_exp <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_50 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_exp, maxit=50 )

summary(MSM_exp)

df4 <- df2 %>% 
  filter(!is.na(ipw_pop))

options(survey.lonely.psu="average")
svy_obj_pop <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_pop, nest = TRUE, data = df4)

MSM_pop <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_50 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_pop, maxit=50 )

summary(MSM_pop)

```



# Dichtomized exposure at 60% exploitation

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"), -c(Industry_Base, OwnRent.Base, DrugProb.Base, EmotProb.Base, KidHealth.Base , SpouseIncome.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ",")) #, Depressed.Base, InterestIncome.Base

time_var <- df %>% select(c("Occupation_Cat", "ConditionPsych_TV", "Annual.OT.Hrs_TV", "YearsWorked_TV", "GradesCompl_TV", "UnionCovered_TV", "Hrly.Slry_TV", "AlcFreq_TV", "TotalLaborIncome_TV" , "Hrly.Slry_TV", "SpouseIncome_TV",  "OT.Income_TV", "Exploitation35_L", "Age"))
time_var <- names(time_var)



```


## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploit35_bin_60 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- glm(denom.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

numer.formula <- as.formula(paste(paste("Exploit35_bin_60 ~ 1"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- glm(numer.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")

pred.numer <- predict(numer.mod, newdata = df, type = "response")


df1 <- df %>%
  mutate(
    ipt_pop_60 = ifelse(Exploit35_bin_60==0,  ((1-pred.numer)/(1-pred.denom)), ((pred.numer)/(pred.denom))),
    ipt_exp_60 = ifelse(Exploit35_bin_60==1, 1, (pred.denom/(1-pred.denom))),
    ipt_pop_60_trunc = ifelse(ipt_pop_60 > quantile(ipt_pop_60, .99, na.rm = T), quantile(ipt_pop_60, .99, na.rm = T), ifelse(ipt_pop_60 < quantile(ipt_pop_60, .01, na.rm = T), quantile(ipt_pop_60, .01, na.rm = T), ipt_pop_60)) ,
    ipt_exp_60_trunc = ifelse(ipt_exp_60 > quantile(ipt_exp_60, .99, na.rm = T), quantile(ipt_exp_60, .99, na.rm = T), ifelse(ipt_exp_60 < quantile(ipt_exp_60, .01, na.rm = T), quantile(ipt_exp_60, .01, na.rm = T), ipt_exp_60))
  ) 

lapply(df1[,c("ipt_pop_60_trunc", "ipt_exp_60_trunc")], summary)
```

## Create variable for IP censoring of K6

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 60))

numer.formula.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +
                            EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base +
                            ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data=df1,
                            weights=Individ.Weight, family=quasibinomial, maxit=100)

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.formula.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)

```

## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw_exp = ipt_exp_60_trunc*ipcw*Individ.Weight,
                      ipw_pop = ipt_pop_60_trunc*ipcw*Individ.Weight,
                      Exploit35_bin_60 = as.factor(Exploit35_bin_60))

```


## MSM

```{r}
library(survey)

df3 <- df2 %>% 
  filter(!is.na(ipw_exp))

options(survey.lonely.psu="average")
svy_obj_exp <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_exp, nest = TRUE, data = df3)


MSM_exp <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_60 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_exp, maxit=60 )

summary(MSM_exp)

df4 <- df2 %>% 
  filter(!is.na(ipw_pop))

options(survey.lonely.psu="average")
svy_obj_pop <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_pop, nest = TRUE, data = df4)

MSM_pop <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_60 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_pop, maxit=60 )

summary(MSM_pop)

```



# Dichtomized exposure at 70% exploitation

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"), -c(Industry_Base, OwnRent.Base, DrugProb.Base, EmotProb.Base, KidHealth.Base , SpouseIncome.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ",")) #, Depressed.Base, InterestIncome.Base

time_var <- df %>% select(c("Occupation_Cat", "ConditionPsych_TV", "Annual.OT.Hrs_TV", "YearsWorked_TV", "GradesCompl_TV", "UnionCovered_TV", "Hrly.Slry_TV", "AlcFreq_TV", "TotalLaborIncome_TV" , "Hrly.Slry_TV", "SpouseIncome_TV",  "OT.Income_TV", "Exploitation35_L", "Age"))
time_var <- names(time_var)



```


## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploit35_bin_70 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- glm(denom.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

numer.formula <- as.formula(paste(paste("Exploit35_bin_70 ~ 1"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- glm(numer.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")

pred.numer <- predict(numer.mod, newdata = df, type = "response")


df1 <- df %>%
  mutate(
    ipt_pop_70 = ifelse(Exploit35_bin_70==0,  ((1-pred.numer)/(1-pred.denom)), ((pred.numer)/(pred.denom))),
    ipt_exp_70 = ifelse(Exploit35_bin_70==1, 1, (pred.denom/(1-pred.denom))),
    ipt_pop_70_trunc = ifelse(ipt_pop_70 > quantile(ipt_pop_70, .99, na.rm = T), quantile(ipt_pop_70, .99, na.rm = T), ifelse(ipt_pop_70 < quantile(ipt_pop_70, .01, na.rm = T), quantile(ipt_pop_70, .01, na.rm = T), ipt_pop_70)) ,
    ipt_exp_70_trunc = ifelse(ipt_exp_70 > quantile(ipt_exp_70, .99, na.rm = T), quantile(ipt_exp_70, .99, na.rm = T), ifelse(ipt_exp_70 < quantile(ipt_exp_70, .01, na.rm = T), quantile(ipt_exp_70, .01, na.rm = T), ipt_exp_70))
  ) 

lapply(df1[,c("ipt_pop_70_trunc", "ipt_exp_70_trunc")], summary)
```

## Create variable for IP censoring of K6

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 70))

numer.formula.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +
                            EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base +
                            ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data=df1,
                            weights=Individ.Weight, family=quasibinomial, maxit=100)

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)

```

## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw_exp = ipt_exp_70_trunc*ipcw*Individ.Weight,
                      ipw_pop = ipt_pop_70_trunc*ipcw*Individ.Weight,
                      Exploit35_bin_70 = as.factor(Exploit35_bin_70))

```


## MSM

```{r}
library(survey)

df3 <- df2 %>% 
  filter(!is.na(ipw_exp))

options(survey.lonely.psu="average")
svy_obj_exp <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_exp, nest = TRUE, data = df3)


MSM_exp <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_70 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_exp, maxit=70 )



df4 <- df2 %>% 
  filter(!is.na(ipw_pop))

options(survey.lonely.psu="average")
svy_obj_pop <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_pop, nest = TRUE, data = df4)

MSM_pop <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_70 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_pop, maxit=70 )

summary(MSM_pop)

```

# Dichtomized exposure at 80% exploitation

## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(Occupation_Base , Race_cat , Sex , Depressed.Base , Annual.OT.Hrs.Base , ExtraJobIncome.Base , Yrs_Union_Cov_Base , Hrly.Slry.Base , N_Change_Occupation_Base)
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ",")) #, Depressed.Base, InterestIncome.Base

time_var <- df %>% select(c("Occupation_Cat", "ConditionPsych_TV", "Annual.OT.Hrs_TV", "YearsWorked_TV", "GradesCompl_TV", "UnionCovered_TV", "Hrly.Slry_TV", "AlcFreq_TV", "TotalLaborIncome_TV" , "Hrly.Slry_TV", "SpouseIncome_TV",  "OT.Income_TV", "Exploitation35_L", "Age"))
time_var <- names(time_var)



```


## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploit35_bin_80 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- glm(denom.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

numer.formula <- as.formula(paste(paste("Exploit35_bin_80 ~ 1"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- glm(numer.formula, family=quasibinomial, data = df, weights = Individ.Weight, maxit=100)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")

pred.numer <- predict(numer.mod, newdata = df, type = "response")


df1 <- df %>%
  mutate(
    ipt_pop_80 = ifelse(Exploit35_bin_80==0,  ((1-pred.numer)/(1-pred.denom)), ((pred.numer)/(pred.denom))),
    ipt_exp_80 = ifelse(Exploit35_bin_80==1, 1, (pred.denom/(1-pred.denom))),
    ipt_pop_80_trunc = ifelse(ipt_pop_80 > quantile(ipt_pop_80, .99, na.rm = T), quantile(ipt_pop_80, .99, na.rm = T), ifelse(ipt_pop_80 < quantile(ipt_pop_80, .01, na.rm = T), quantile(ipt_pop_80, .01, na.rm = T), ipt_pop_80)) ,
    ipt_exp_80_trunc = ifelse(ipt_exp_80 > quantile(ipt_exp_80, .999937, na.rm = T), quantile(ipt_exp_80, .999937, na.rm = T), ifelse(ipt_exp_80 < quantile(ipt_exp_80, .000063, na.rm = T), quantile(ipt_exp_80, .000063, na.rm = T), ipt_exp_80))
  ) 

lapply(df1[,c("ipt_pop_80_trunc", "ipt_exp_80_trunc")], summary)

```

## Create variable for IP censoring of K6

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 80))

numer.formula.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +
                            EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base +
                            ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data=df1,
                            weights=Individ.Weight, family=quasibinomial, maxit=100)

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)

```

## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw_exp = ipt_exp_80_trunc*ipcw*Individ.Weight,
                      ipw_pop = ipt_pop_80_trunc*ipcw*Individ.Weight,
                      Exploit35_bin_80 = as.factor(Exploit35_bin_80))

```


## MSM

```{r}
library(survey)

df3 <- df2 %>% 
  filter(!is.na(ipw_exp))

options(survey.lonely.psu="average")
svy_obj_exp <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_exp, nest = TRUE, data = df3)


MSM_exp <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_80 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_exp, maxit=80 )

summary(MSM_exp)

df4 <- df2 %>% 
  filter(!is.na(ipw_pop))

options(survey.lonely.psu="average")
svy_obj_pop <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw_pop, nest = TRUE, data = df4)

MSM_pop <- svyglm(as.formula(c(paste(paste("MMI_TV ~ Exploit35_bin_80 +"), paste(baseline_vars, collapse = " + ")))), family=quasibinomial, design = svy_obj_pop, maxit=80 )

summary(MSM_pop)

```



# Normal with survey weights

## Setup

```{r}

load("/Users/SJP1/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")
library(rio)
library(survey)
library(tidyverse)
library(geepack)
library(broom)
df <- as.data.frame(Full_CleanedData)

df <- df %>% mutate(
              Exploitation40_L = lag(Exploitation40),
              Exploit40_cat = as.factor(ntile(Exploitation40, 10)),
              Sex = as.factor(Sex),
              Exploitation40_0 = ifelse(Exploitation40 < quantile(Exploitation40, 0.1, na.rm = TRUE), quantile(Exploitation40, 0.1, na.rm = TRUE), Exploitation40),
              Exploit40_0_cat = as.factor(ntile(Exploitation40_0, 10)),
              Exploitation40_0_L = lag(Exploitation40_0))

df <- as.data.frame(df)
```


```{r}

df <- df %>%
  select(-c(GenHealth_TV, GenHealth.Base, RelationToHead,  SampErrClust_cume, SampErrStrat_cume, Sex_cume, Year_cume, K6_TV_cume, RelationToHead_cume, Age_cume, Top_1_Percent_cume, Exploitation40_cume, Exploitation40_cume, Extra.Job_TV, Individ.Weight_cume, DrLearnDisord.Base, DrEmotProb.Base, N_Change_Industry_Base, DrMemLoss.Base, InterestIncome_TV, OT.Hrs.Main.Job_cume, SpouseIncome_cume, SpouseIncome_TV_cume, OT.Hrs.Main.Job, OT.Hrs.Main.Job_cume, SpouseIncome_cume, FamilyComp_cume, FamilySize_TV_cume, OT.Income_TV_cume, WageSal.Head_cume, TotalLaborIncome_TV_cume, WageSal.Head, YearsWorked_TV_cume, OwnRent_TV, SpouseIncome, EmploymentStatus_TV, WorkHrs_TV_cume, Annual.OT.Hrs_TV_cume, GenHealth.Base, RelationToHead_L, GenHealth_TV_L), -contains("_0"), -contains("cat"), contains("Race_cat"), -contains("35"), Occupation_Cat, N_Change_Employ_Base
    ) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(Year = as.factor(Year)) %>% 
  filter(Occupation_Cat != "Military")

df <- droplevels(df)

#options(survey.lonely.psu="average")
#svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~Individ.Weight, nest = TRUE, data = df)

#names(df)


```



## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df %>% select(contains("Base"), -c(DrugProb.Base, EmotProb.Base, KidHealth.Base, Industry_Base, OwnRent.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ","))

time_var <- df %>% select(contains("_L"), -contains("cume"), -contains("Base"), -c(ID:SampErrStrat, Individ.Weight, Year, SpouseIncome_L, Top_1_Percent_L, SpouseIncome_L, SMI_TV_L, MMI_TV_L,  FamilyComp_cume_L, TotalLaborIncome_TV_cume_L, FamilySize_TV_cume_L, TotalLaborIncome_TV_L, WorkHrs_TV_L, WageSal.Head_L, DrinksPerDay_TV_L, EverSmoked_TV_L, Age_L, FamilyComp_L, FamilySize_TV_L, K6_TV_L, EmploymentStatus_TV_L, Extra.Job_TV_L))
time_var <- names(time_var)

```

## Create IP treatment weights 

```{r}

denom.formula <- as.formula(c(paste("Exploitation40 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod <- lm(denom.formula, data = df, weights = Individ.Weight)

numer.formula <- as.formula(paste(paste("Exploitation40 ~ Exploitation40_L"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod <- lm(numer.formula, data = df, weights = Individ.Weight)

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))

pred.denom <- predict(denom.mod, newdata = df, type = "response")
pred.numer <- predict(numer.mod, newdata = df, type = "response")

iptw.numerator <- dnorm(df$Exploitation40, pred.numer, summary(numer.mod)$sigma)
iptw.denominator <- dnorm(df$Exploitation40, pred.denom, summary(denom.mod)$sigma)

df1 <- df %>%
  mutate(
    iptw = iptw.numerator / iptw.denominator,
    iptw.trunc = ifelse(iptw < quantile(iptw, 0.1, na.rm = TRUE), quantile(iptw, 0.1, na.rm = TRUE), ifelse(iptw > quantile(iptw, 0.99, na.rm = TRUE), quantile(iptw, 0.99, na.rm = TRUE), iptw))
  ) 


#quantile(df1$iptw.trunc, seq(0,1,.01), na.rm=TRUE)
#summary(df1$iptw.trunc)

#df1 %>% group_by(Year) %>% 
#  summarise(mean(iptw.trunc, na.rm=TRUE))

summary(df1$iptw)
summary(numer.mod)
```


## Choose variables for IP censoring weights

```{r}
df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

baseline_vars_cens <- df %>% select(contains("Base"), -c(DrugProb.Base, EmotProb.Base, KidHealth.Base, Industry_Base, OwnRent.Base, Depressed.Base, Occupation_Base))
baseline_vars_cens <- c("Sex", "Race_cat", paste(names(baseline_vars_cens), sep = ","))

time_var_cens <- df %>% select(-contains("_L"), -contains("cume"), -contains("Base"), -c(ID:SampErrStrat, Individ.Weight, Year, Top_1_Percent, SMI_TV, MMI_TV,  TotalLaborIncome_TV, WorkHrs_TV, DrinksPerDay_TV, EverSmoked_TV, Age, FamilyComp, FamilySize_TV, K6_TV))
time_var <- names(time_var)

 
```

## Create IP Censoring weights

```{r}

denom.formula.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(c("N_Change_Occupation_Base","Depressed.Base","N_Change_Employ_Base",
  "EmploymentStatus.Base","InterestIncome.Base","Yrs_Self_Emp_Base","Hrly.Slry.Base", "Yrs_Union_Cov_Base","ExtraJobIncome.Base","Annual.OT.Hrs.Base","Yrs.Extra.Job_Base", "Hrs.Extra.Jobs.Base"), collapse = " + "), paste(time_var, collapse = " + "))))

denom.mod.cens <- glm(denom.formula.cens, data = df1, weights = Individ.Weight, family = "quasibinomial", control = list(maxit = 100))

numer.formula.cens <- as.formula(c(paste(paste("K6_censored ~ "), paste(baseline_vars_cens, collapse = " + "))))

numer.mod.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +  EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df1, weights = Individ.Weight,  family = "quasibinomial", control = list(maxit = 100))

#denom.mod$xlevels[["Year"]] <- union(denom.mod$xlevels, levels(df$Year))
pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df1, type = "response"))
 
df2 <- df1 %>%
  mutate(ipcw = ifelse(df1$K6_censored == 0, ((1-pred.numer.cen)/(1-pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df2$ipcw)
```


## Multiply IPTW, censoring weights, and survey weights

```{r}

df2 <- df2 %>% mutate(ipw = iptw*ipcw*Individ.Weight)

```


## MSM

```{r}

df2 <- df2 %>% 
  filter(!is.na(ipw))

df2 <- df2 %>%  mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df2 <- arrange(df2, ID, Year)

options(survey.lonely.psu="average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df2)


MSM1 <- svyglm(as.formula(c(paste(paste("MI_TV ~ Exploitation40_L +"), paste(baseline_vars, collapse = " + ")))), design = svy_obj, maxit=50, family=poisson)

MSM1_tb <- tidy(MSM1, exponentiate=TRUE, conf.int=TRUE)
MSM1_tb <- MSM1_tb %>% select(term, estimate, conf.low, conf.high) %>% 
  mutate_if(is.numeric, ~round(.,2)) %>% 
  mutate(Outcome = "MI",
        Weighting = "Survey, exposure, censoring")

MSM2 <- svyglm(as.formula(c(paste(paste("K6_TV ~ Exploitation40_L +"), paste(baseline_vars, collapse = " + ")))), design = svy_obj, maxit=50)


MSM2_tb <- tidy(MSM2, conf.int=TRUE)
MSM2_tb <- MSM2_tb %>% select(term, estimate,conf.low, conf.high) %>% 
  mutate_if(is.numeric, ~round(.,2)) %>% 
    mutate(Outcome = "K6",
        Weighting = "Survey, exposure, censoring")

```


# Normal NO survey weights

## Setup

```{r}

load("/Users/SJP1/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")
library(rio)
library(survey)
library(tidyverse)
library(geepack)
library(broom)
df_ns <- as.data.frame(Full_CleanedData)

df_ns <- df_ns %>% mutate(
              Exploitation40_L = lag(Exploitation40),
              Exploit40_cat = as.factor(ntile(Exploitation40, 10)),
              Sex = as.factor(Sex),
              Exploitation40_0 = ifelse(Exploitation40 < quantile(Exploitation40, 0.1, na.rm = TRUE), quantile(Exploitation40, 0.1, na.rm = TRUE), Exploitation40),
              Exploit40_0_cat = as.factor(ntile(Exploitation40_0, 10)),
              Exploitation40_0_L = lag(Exploitation40_0))

df_ns <- as.data.frame(df_ns)
```


```{r}

df_ns <- df_ns %>%
  select(-c(GenHealth_TV, GenHealth.Base, RelationToHead,  SampErrClust_cume, SampErrStrat_cume, Sex_cume, Year_cume, K6_TV_cume, RelationToHead_cume, Age_cume, Top_1_Percent_cume, Exploitation40_cume, Exploitation40_cume, Extra.Job_TV, Individ.Weight_cume, DrLearnDisord.Base, DrEmotProb.Base, N_Change_Industry_Base, DrMemLoss.Base, InterestIncome_TV, OT.Hrs.Main.Job_cume, SpouseIncome_cume, SpouseIncome_TV_cume, OT.Hrs.Main.Job, OT.Hrs.Main.Job_cume, SpouseIncome_cume, FamilyComp_cume, FamilySize_TV_cume, OT.Income_TV_cume, WageSal.Head_cume, TotalLaborIncome_TV_cume, WageSal.Head, YearsWorked_TV_cume, OwnRent_TV, SpouseIncome, EmploymentStatus_TV, WorkHrs_TV_cume, Annual.OT.Hrs_TV_cume, GenHealth.Base, RelationToHead_L, GenHealth_TV_L), -contains("_0"), -contains("cat"), contains("Race_cat"), -contains("35"), Occupation_Cat, N_Change_Employ_Base
    ) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(Year = as.factor(Year)) %>% 
  filter(Occupation_Cat != "Military")

df_ns <- droplevels(df_ns)

#options(survey.lonely.psu="average")
#svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~Individ.Weight, nest = TRUE, data = df_ns)

#names(df_ns)


```



## Choose variables for inverse probability of treament weights
```{r}

baseline_vars <- df_ns %>% select(contains("Base"), -c(DrugProb.Base, EmotProb.Base, KidHealth.Base, Industry_Base, OwnRent.Base))
baseline_vars <- c("Sex", "Race_cat", paste(names(baseline_vars), sep = ","))

time_var <- df_ns %>% select(contains("_L"), -contains("cume"), -contains("Base"), -c(ID:SampErrStrat, Individ.Weight, Year, SpouseIncome_L, Top_1_Percent_L, SpouseIncome_L, SMI_TV_L, MMI_TV_L,  FamilyComp_cume_L, TotalLaborIncome_TV_cume_L, FamilySize_TV_cume_L, TotalLaborIncome_TV_L, WorkHrs_TV_L, WageSal.Head_L, DrinksPerDay_TV_L, EverSmoked_TV_L, Age_L, FamilyComp_L, FamilySize_TV_L, K6_TV_L, EmploymentStatus_TV_L, Extra.Job_TV_L))
time_var <- names(time_var)

```

## Create IP treatment weights 

```{r}

denom.formula_ns <- as.formula(c(paste("Exploitation40 ~ "), paste(paste(baseline_vars, collapse = " + "), paste(time_var, collapse = " + "), sep = "+")))

denom.mod_ns_ns <- lm(denom.formula_ns, data = df_ns)

numer.formula_ns <- as.formula(paste(paste("Exploitation40 ~ Exploitation40_L"), paste(baseline_vars, collapse = " + "), sep = "+"))

numer.mod_ns_ns <- lm(numer.formula_ns, data = df_ns)

#denom.mod_ns_ns$xlevels[["Year"]] <- union(denom.mod_ns_ns$xlevels, levels(df_ns$Year))

pred_nsdenom <- predict(denom.mod_ns_ns, newdata = df_ns, type = "response")
pred_nsnumer <- predict(numer.mod_ns_ns, newdata = df_ns, type = "response")

iptw.numer_ns <- dnorm(df_ns$Exploitation40, pred_nsnumer, summary(numer.mod_ns_ns)$sigma)
iptw.denom_ns <- dnorm(df_ns$Exploitation40, pred_nsdenom, summary(denom.mod_ns_ns)$sigma)

df_ns1 <- df_ns %>%
  mutate(
    iptw = iptw.numer_ns / iptw.denom_ns,
    iptw.trunc = ifelse(iptw < quantile(iptw, 0.1, na.rm = TRUE), quantile(iptw, 0.1, na.rm = TRUE), ifelse(iptw > quantile(iptw, 0.99, na.rm = TRUE), quantile(iptw, 0.99, na.rm = TRUE), iptw))
  ) 


#quantile(df_ns1$iptw.trunc, seq(0,1,.01), na.rm=TRUE)
#summary(df_ns1$iptw.trunc)

#df_ns1 %>% group_by(Year) %>% 
#  summarise(mean(iptw.trunc, na.rm=TRUE))

summary(df_ns1$iptw)
```


## Choose variables for IP censoring weights

```{r}
df_ns1 <- df_ns1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

baseline_vars_cens <- df_ns %>% select(contains("Base"), -c(DrugProb.Base, EmotProb.Base, KidHealth.Base, Industry_Base, OwnRent.Base, Depressed.Base, Occupation_Base))
baseline_vars_cens <- c("Sex", "Race_cat", paste(names(baseline_vars_cens), sep = ","))

time_var_cens <- df_ns %>% select(-contains("_L"), -contains("cume"), -contains("Base"), -c(ID:SampErrStrat, Individ.Weight, Year, Top_1_Percent, SMI_TV, MMI_TV,  TotalLaborIncome_TV, WorkHrs_TV, DrinksPerDay_TV, EverSmoked_TV, Age, FamilyComp, FamilySize_TV, K6_TV))
time_var <- names(time_var)

 
```

## Create IP Censoring weights

```{r}

denom.formula_ns.cens <- as.formula(c(paste("K6_censored ~ "), paste(paste(c("N_Change_Occupation_Base","Depressed.Base","N_Change_Employ_Base",
  "EmploymentStatus.Base","InterestIncome.Base","Yrs_Self_Emp_Base","Hrly.Slry.Base", "Yrs_Union_Cov_Base","ExtraJobIncome.Base","Annual.OT.Hrs.Base","Yrs.Extra.Job_Base", "Hrs.Extra.Jobs.Base"), collapse = " + "), paste(time_var, collapse = " + "))))

denom.mod_ns_ns.cens <- glm(denom.formula_ns.cens, data = df_ns1, family = "quasibinomial", control = list(maxit = 100))

numer.formula_ns.cens <- as.formula(c(paste(paste("K6_censored ~ "), paste(baseline_vars_cens, collapse = " + "))))

numer.mod_ns_ns.cens <- glm(K6_censored ~ Sex  + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +  EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base +  Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_ns1,  family = "quasibinomial", control = list(maxit = 100))

#denom.mod_ns_ns$xlevels[["Year"]] <- union(denom.mod_ns_ns$xlevels, levels(df_ns$Year))
pred_nsdenom.cen <- as.numeric(predict(denom.mod_ns_ns.cens, newdata = df_ns1, type = "response"))
pred_nsnumer.cen <- as.numeric(predict(numer.mod_ns_ns.cens, newdata = df_ns1, type = "response"))
 
df_ns2 <- df_ns1 %>%
  mutate(ipcw = ifelse(df_ns1$K6_censored == 0, ((1-pred_nsnumer.cen)/(1-pred_nsdenom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )

summary(df_ns2$ipcw)
```


## Multiply IPTW, censoring weights, and survey weights

```{r}

df_ns2 <- df_ns2 %>% mutate(ipw = iptw*ipcw)

```


## MSM

```{r}

df_ns2 <- df_ns2 %>% 
  filter(!is.na(ipw))

df_ns2 <- df_ns2 %>%  mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df_ns2 <- arrange(df_ns2, ID, Year)


MSM_ns2 <- geeglm(as.formula(c(paste(paste("K6_TV ~ Exploitation40_L +"), paste(baseline_vars, collapse = " + ")))), data = df_ns2, id = ID, corstr = "exchangeable", weights = ipw)

MSM_ns2_tb <- tidy(MSM_ns2, conf.int=TRUE)
MSM_ns2_tb <- MSM_ns2_tb %>% select(term, estimate,conf.low, conf.high) %>% 
  mutate_if(is.numeric, ~round(.,2)) %>% 
    mutate(Outcome = "K6",
        Weighting = "Exposure, censoring")


df_ns2 <- df_ns2 %>% filter(!is.na(MI_TV))

MSM_ns1 <- geeglm(as.formula(c(paste(paste("MI_TV ~ Exploitation40_L +"), paste(baseline_vars, collapse = " + ")))), data = df_ns2, family=poisson, id = ID, corstr = "exchangeable", weights = ipw)

summary(MSM_ns1)

MSM_ns1_tb <- tidy(MSM_ns1, conf.int=TRUE, exponentiate = TRUE)
MSM_ns1_tb <- MSM_ns1_tb %>% select(term, estimate,conf.low, conf.high) %>% 
  mutate_if(is.numeric, ~round(.,2)) %>% 
    mutate(Outcome = "MI",
        Weighting = "Exposure, censoring")
```


# Weight tables
```{r, eval-FALSE}

##SPLIT UP THE TABLES

library(kableExtra)

Table_MI <- rbind(MSM1_tb, MSM_ns1_tb)
Table_MI <- filter(Table_MI, term=="Exploitation40_L") %>% 
  select(Weighting, term, estimate, conf.low, conf.high) %>% 
  mutate(`95% CI` = c("(1.04, 2.87)", "(0.92, 1.59)")) %>% 
    select(-conf.low, -conf.high)
Table_K6 <- rbind(MSM2_tb, MSM_ns2_tb)
Table_K6 <- filter(Table_K6, term=="Exploitation40_L") %>% 
  select(estimate, conf.low, conf.high) %>% 
  mutate(`95% CI` = c("(1.12, 5.52)", "(0.45, 4.06)")) %>% 
  select(-conf.low, -conf.high)

names(Table_MI) <- c("Weighting", "Exposure", "Odds Ratio", "95% CI")
names(Table_K6) <- c( "Beta", "95% CI")

Table <- cbind(Table_MI, Table_K6)
Table$Exposure <- ifelse(Table$Exposure == "Exploitation40_L", "Exploitation", NA)


kable(Table, caption = "Inverse-probability-weighted marginal structural model estimates of the effect of exploitation on mental illness and psychological distress") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>% 
  add_header_above(c(" " = 2, "Mental Illness (Yes/No)" = 2, "K6 Scale" = 2))
```

