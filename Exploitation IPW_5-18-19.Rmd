---
title: "IPW-MSM for the effect of exploitation on mental illness"
output:
  html_document:
    df_print: paged
---

# Regular regression with survey weights

```{r, eval=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")
library(rio)
library(survey)
library(tidyverse)
library(geepack)
library(broom)
df <- as.data.frame(Full_CleanedData)

df <- df %>% mutate(
  Exploitation40_L = lag(Exploitation40),
  Exploit40_cat = as.factor(ntile(Exploitation40, 10)),
  Sex = as.factor(Sex),
  Exploitation40_0 = ifelse(Exploitation40 < quantile(Exploitation40, 0.1, na.rm = TRUE), quantile(Exploitation40, 0.1, na.rm = TRUE), Exploitation40),
  Exploit40_0_cat = as.factor(ntile(Exploitation40_0, 10)),
  Exploitation40_0_L = lag(Exploitation40_0)
)

df <- as.data.frame(df)
df <- droplevels(df)


```

## Mental illnes (K6 >= 5 yes/no)
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df <- df %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~Individ.Weight, nest = TRUE, data = df)

model1 <- svyglm(MI_TV ~ Exploitation40 + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L + 
    OT.Hrs.Main.Job_L + OT.Income_TV_L + ConditionPsych_TV_L + 
    AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L + 
    Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L + 
    YearsWorked_TV_L, design = svy_obj, maxit = 50, family = binomial)

model1_tb <- tidy(model1, exponentiate = TRUE, conf.int = TRUE)
model1_tb <- model1_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI",
    Weighting = "Survey, exposure, censoring"
  )
```

## K6 scale
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
model2 <- svyglm(K6_TV ~ Exploitation40 + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L + 
    OT.Hrs.Main.Job_L + OT.Income_TV_L + ConditionPsych_TV_L + 
    AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L + 
    Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L + 
    YearsWorked_TV_L, design = svy_obj, maxit = 50)


model2_tb <- tidy(model2, conf.int = TRUE)
model2_tb <- model2_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "K6",
    Weighting = "Survey, exposure, censoring"
  )
```

# Regular regression without survey weighting

## Mental illnes (K6 >= 5 yes/no)
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
model1_ns <- glm(MI_TV ~ Exploitation40 + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L + 
    OT.Hrs.Main.Job_L + OT.Income_TV_L + ConditionPsych_TV_L + 
    AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L + 
    Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L + 
    YearsWorked_TV_L, data = df, maxit = 50, family = binomial)

model1_ns <- tidy(model1_ns, exponentiate = TRUE, conf.int = TRUE, effects = "fixed")
model1_ns <- model1_ns %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI",
    Weighting = "Survey, exposure, censoring"
  )
```

## K6 scale
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
model2_ns <- glm(K6_TV ~ Exploitation40 + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L + 
    OT.Hrs.Main.Job_L + OT.Income_TV_L + ConditionPsych_TV_L + 
    AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L + 
    Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L + 
    YearsWorked_TV_L, data = df, maxit = 50)


model2_ns <- tidy(model2_ns, conf.int = TRUE)
model2_ns <- model2_ns %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "K6",
    Weighting = "Survey, exposure, censoring"
  )
```

# IPW-MSM

## Probability of exposure and censoring models, continuous exposure, with survey weights


### Create IP exposure weights 

```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}


denom.mod <- lm(Exploitation40 ~ Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L + 
    OT.Hrs.Main.Job_L + OT.Income_TV_L + ConditionPsych_TV_L + 
    AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L + 
    Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L + 
    YearsWorked_TV_L + Exploitation40_L, data = df, weights = Individ.Weight)


numer.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df, weights = Individ.Weight)

pred.denom <- predict(denom.mod, newdata = df, type = "response")
pred.numer <- predict(numer.mod, newdata = df, type = "response")

ipew.numerator <- dnorm(df$Exploitation40, pred.numer, summary(numer.mod)$sigma)
ipew.denominator <- dnorm(df$Exploitation40, pred.denom, summary(denom.mod)$sigma)

df1 <- df %>%
  mutate(
    ipew = ipew.numerator / ipew.denominator,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE), ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew))
  )

```


### Create IP Censoring weights

```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df1 <- df1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Depressed.Base + Occupation_Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV + OT.Income_TV + ConditionPsych_TV +
    AlcFreq_TV + GradesCompl_TV + Hrly.Slry_TV + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV +
    Exploitation40 + Occupation_Cat, data = df1, weights = Individ.Weight, family = "quasibinomial",
  control = list(maxit = 100))


numer.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Occupation_Base + Depressed.Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df1, weights = Individ.Weight, family =
    "quasibinomial", control = list(maxit = 100))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df1, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df1, type = "response"))

df2 <- df1 %>%
  mutate(
    ipcw = ifelse(df1$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )
```


### Multiply IPEW, censoring weights, and survey weights

```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df2 <- df2 %>% mutate(ipw = ipew * ipcw * Individ.Weight)
```


## MSM

### Create survey design object
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df2 <- df2 %>%
  filter(!is.na(ipw))

df2 <- df2 %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df2 <- arrange(df2, ID, Year)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df2)
```

### Mental illnes (K6 >= 5 yes/no)
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
MSM1 <- svyglm(MI_TV ~ Exploitation40_L + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50, family = binomial)

MSM1_tb <- tidy(MSM1, exponentiate = TRUE, conf.int = TRUE)
MSM1_tb <- MSM1_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI",
    Weighting = "Survey, exposure, censoring"
  )
```

### K6 scale
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
MSM2 <- svyglm(K6_TV ~ Exploitation40_L + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50)


MSM2_tb <- tidy(MSM2, conf.int = TRUE)
MSM2_tb <- MSM2_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "K6",
    Weighting = "Survey, exposure, censoring"
  )
```


## Probability of exposure and censoring models, continuous exposure, no survey weights

```{r, eval=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

load("/Users/sjp2154/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/Full_CleanedData.RData")
library(rio)
library(survey)
library(tidyverse)
library(geepack)
library(broom)
df_ns <- as.data.frame(Full_CleanedData)

df_ns <- df_ns %>% mutate(
  Exploitation40_L = lag(Exploitation40),
  Exploit40_cat = as.factor(ntile(Exploitation40, 10)),
  Sex = as.factor(Sex),
  Exploitation40_0 = ifelse(Exploitation40 < quantile(Exploitation40, 0.1, na.rm = TRUE), quantile(Exploitation40, 0.1, na.rm = TRUE), Exploitation40),
  Exploit40_0_cat = as.factor(ntile(Exploitation40_0, 10)),
  Exploitation40_0_L = lag(Exploitation40_0)
)

df_ns <- as.data.frame(df_ns)
```


```{r, eval=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

df_ns <- df_ns %>%
  select(-c(GenHealth_TV, GenHealth.Base, RelationToHead, SampErrClust_cume, SampErrStrat_cume,
    Sex_cume, Year_cume, K6_TV_cume, RelationToHead_cume, Age_cume, Top_1_Percent_cume,
    Exploitation40_cume, Exploitation40_cume, Extra.Job_TV, Individ.Weight_cume, DrLearnDisord.Base,
    DrEmotProb.Base, N_Change_Industry_Base, DrMemLoss.Base, InterestIncome_TV, OT.Hrs.Main.Job_cume,
    SpouseIncome_cume, SpouseIncome_TV_cume, OT.Hrs.Main.Job, OT.Hrs.Main.Job_cume, SpouseIncome_cume,
    FamilyComp_cume, FamilySize_TV_cume, OT.Income_TV_cume, WageSal.Head_cume,
    TotalLaborIncome_TV_cume, WageSal.Head, YearsWorked_TV_cume, OwnRent_TV, SpouseIncome,
    EmploymentStatus_TV, WorkHrs_TV_cume, Annual.OT.Hrs_TV_cume, GenHealth.Base, RelationToHead_L,
    GenHealth_TV_L), -contains("_0"), -contains("cat"), contains("Race_cat"), -contains("35"),
    Occupation_Cat, N_Change_Employ_Base) %>%
  mutate_if(is.character, as.factor) %>%
  mutate(Year = as.factor(Year)) %>%
  filter(Occupation_Cat != "Military")

df_ns <- droplevels(df_ns)

```


### Create IP exposure weights 

```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

denom.mod_ns_ns <- lm(Exploitation40 ~ Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L + 
    OT.Hrs.Main.Job_L + OT.Income_TV_L + ConditionPsych_TV_L + 
    AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L + 
    Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L + 
    YearsWorked_TV_L + Exploitation40_L, data = df_ns)


numer.mod_ns_ns <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_ns)

pred_nsdenom <- predict(denom.mod_ns_ns, newdata = df_ns, type = "response")
pred_nsnumer <- predict(numer.mod_ns_ns, newdata = df_ns, type = "response")

ipew.numer_ns <- dnorm(df_ns$Exploitation40, pred_nsnumer, summary(numer.mod_ns_ns)$sigma)
ipew.denom_ns <- dnorm(df_ns$Exploitation40, pred_nsdenom, summary(denom.mod_ns_ns)$sigma)

df_ns1 <- df_ns %>%
  mutate(
    ipew = ipew.numer_ns / ipew.denom_ns,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE), ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew))
  )

```


### Create IP Censoring weights

```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df_ns1 <- df_ns1 %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod_ns_ns.cens <- glm(K6_censored ~ N_Change_Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base +
    Annual.OT.Hrs.Base +  Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Sex + Annual.OT.Hrs_TV + OT.Income_TV + ConditionPsych_TV +
    AlcFreq_TV + GradesCompl_TV +  Hrly.Slry_TV + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV + Exploitation40 + Race_cat +
    Occupation_Cat, data = df_ns1,
  family = "quasibinomial", control = list(maxit = 100))

numer.mod_ns_ns.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Occupation_Base + Depressed.Base + N_Change_Employ_Base +
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base +
    Annual.OT.Hrs.Base + OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_ns1, family = "quasibinomial", 
  control = list(maxit = 100))

# denom.mod_ns_ns$xlevels[["Year"]] <- union(denom.mod_ns_ns$xlevels, levels(df_ns$Year))
pred_nsdenom.cen <- as.numeric(predict(denom.mod_ns_ns.cens, newdata = df_ns1, type = "response"))
pred_nsnumer.cen <- as.numeric(predict(numer.mod_ns_ns.cens, newdata = df_ns1, type = "response"))

df_ns2 <- df_ns1 %>%
  mutate(
    ipcw = ifelse(df_ns1$K6_censored == 0, ((1 - pred_nsnumer.cen) / (1 - pred_nsdenom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )
```


### Multiply IPEW, censoring weights, and survey weights

```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df_ns2 <- df_ns2 %>% mutate(ipw = ipew * ipcw)
```


## MSM

### Filter
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

df_ns2 <- df_ns2 %>%
  filter(!is.na(ipw))

df_ns2 <- df_ns2 %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df_ns2 <- arrange(df_ns2, ID, Year)
```

### Mental illnes (K6 >= 5, yes/no)
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
df_ns2 <- df_ns2 %>% filter(!is.na(MI_TV))

MSM_ns1 <- geeglm(MI_TV ~ Exploitation40_L + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_ns2, family = binomial, id = ID, corstr = "exchangeable", weights = ipw)

summary(MSM_ns1)

MSM_ns1_tb <- tidy(MSM_ns1, conf.int = TRUE, exponentiate = TRUE)
MSM_ns1_tb <- MSM_ns1_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI",
    Weighting = "Exposure, censoring"
  )
```

### K6 scale
```{r, eval=TRUE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

MSM_ns2 <- geeglm(K6_TV ~ Exploitation40_L + Sex + Race_cat + N_Change_Occupation_Base + 
    Occupation_Base + Depressed.Base + N_Change_Employ_Base + 
    EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base + 
    Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base + 
    ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base + 
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_ns2, id = ID, corstr = "exchangeable", weights = ipw)

MSM_ns2_tb <- tidy(MSM_ns2, conf.int = TRUE)
MSM_ns2_tb <- MSM_ns2_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "K6",
    Weighting = "Exposure, censoring"
  )
```

# Distribution of inverse probability of exposure weights
```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)

Weights <- data.frame(`Survey Design` = c("Yes", "Yes", "No", "No"), Weight = c("IPEW", "IPCW", "IPEW", "IPCW"), Mean = c(mean(df1$ipew, na.rm = TRUE), mean(df2$ipcw, na.rm = TRUE), mean(df_ns1$ipew, na.rm = TRUE), mean(df_ns2$ipcw, na.rm = TRUE)), Min = c(min(df1$ipew, na.rm = TRUE),  min(df2$ipcw, na.rm = TRUE), min(df_ns1$ipew, na.rm = TRUE), min(df_ns2$ipcw, na.rm = TRUE)), Max = c(max(df1$ipew, na.rm = TRUE), max(df2$ipcw, na.rm = TRUE), max(df_ns1$ipew, na.rm = TRUE), max(df_ns2$ipcw, na.rm = TRUE)))

names(Weights) <- c("Survey Design", "Weight", "Mean", "Min", "Max")

Weights <- Weights %>% select(-`Survey Design`)

kable(Weights, caption = "Distribution of inverse probability weights", digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) %>%
  group_rows("Survey Weighted", 1, 2) %>%
  group_rows("Not Survey Weighted", 3, 4)
```



# IPW-MSM Results Table
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
Table_MI <- rbind(MSM1_tb, MSM_ns1_tb)
Table_MI <- filter(Table_MI, term == "Exploitation40_L") %>%
  select(Weighting, term, estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = c("(1.04, 2.87)", "(0.92, 1.59)")) %>%
  select(-conf.low, -conf.high)
Table_K6 <- rbind(MSM2_tb, MSM_ns2_tb)
Table_K6 <- filter(Table_K6, term == "Exploitation40_L") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = c("(1.12, 5.52)", "(0.45, 4.06)")) %>%
  select(-conf.low, -conf.high)

names(Table_MI) <- c("Weighting", "Exposure", "Odds Ratio", "95% CI")
names(Table_K6) <- c("Beta", "95% CI")

Table <- cbind(Table_MI, Table_K6)
Table$Exposure <- ifelse(Table$Exposure == "Exploitation40_L", "Exploitation", NA)


kable(Table, caption = "Inverse-probability-weighted marginal structural model estimates of the effect of exploitation on mental illness and psychological distress") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  add_header_above(c(" " = 2, "Mental Illness (Yes/No)" = 2, "K6 Scale" = 2))
```



