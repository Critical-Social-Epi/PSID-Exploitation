---
title: '“The Serpent of their Agonies”: Exploitation As Structural Determinant of
  Mental Illness'
author: Seth J. Prins, Sarah McKetta, Jonathan Platt, Carles Muntaner, Katherine M.
  Keyes, Lisa M. Bates
date: "September, 2020"
output:
  html_document:
    toc: yes
    df_print: paged
  pdf_document:
    toc: yes
subtitle: Analysis Notebook
always_allow_html: yes
---

# Load Cleaned Data

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

load("xxx.RData")

library(rio)
library(survey)
library(tidyverse)
library(geepack)
library(broom)
library(broom.mixed)
library(broomExtra)
Full_CleanedData <- as.data.frame(Full_CleanedData)

Full_CleanedData <- Full_CleanedData %>% mutate(
  Exploitation40_L = lag(Exploitation40),
  Sex = as.factor(Sex),
  K6_TV = ifelse(K6_TV > 24, NA, K6_TV),
  SMI_TV = ifelse(K6_TV >= 13 & K6_TV != 99, 1, ifelse(!is.na(K6_TV), 0, NA)),
  MMI_TV = ifelse(K6_TV >= 5 & K6_TV < 13 & K6_TV != 99, 1, ifelse(!is.na(K6_TV), 0, NA)),
  MI_TV = ifelse(K6_TV >= 5 & K6_TV != 99, 1, ifelse(!is.na(K6_TV), 0, NA)),
  Exploitation_Hours = WorkHrs_TV - 2080,
  Exploitation_Hours_L = lag(Exploitation_Hours),
  Exploitation_Hours_52 = (WorkHrs_TV - 2080)/52,
  Exploitation_Hours_52_L = lag(Exploitation_Hours_52),
  HourlyWage40_2 = ifelse(WorkHrs_TV >= 2080, ((TotalLaborIncome_TV - OT.Income_TV_L) / 2080), NA),
  TrueHourlyWage40_2 = ifelse(WorkHrs_TV >= 2080, TotalLaborIncome_TV / WorkHrs_TV, NA),
  Exploitation40_2 = (HourlyWage40_2 - TrueHourlyWage40_2) / HourlyWage40_2,
  Exploitation40_2_L = lag(Exploitation40)
)


Full_CleanedData <- Full_CleanedData %>% 
  mutate(MinWage = case_when(
    Year %in% c(2003:2005) ~ .75*(10712),
    Year == 2007 ~ .75*(12168),
    Year %in% c(2009:2017) ~ .75*(15080),
    TRUE ~ NA_real_)
  )

df <- Full_CleanedData

df <- filter(df,  TotalLaborIncome_TV > MinWage, WorkHrs_TV >= 2080, Occupation_Base != "Military", Occupation_Cat != "Military")

df <- as.data.frame(df)
df <- droplevels(df)

```




# Main Analysis

## Linear inverse probability of exposure weights

### Probability of exposure models

```{r, eval=FALSE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}


denom.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
     InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + Occupation_Base +
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L  + OT.Income_TV_L + Occupation_Cat_L +
  AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L +
  Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L +
  YearsWorked_TV_L  + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age + Year,
data = df,
weights = Individ.Weight
)


numer.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
     InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base,
data = df,
weights = Individ.Weight
)

pred.denom <- predict(denom.mod, newdata = denom.mod$model, type = "response")
pred.numer <- predict(numer.mod, newdata = numer.mod$model, type = "response")

ipew.numerator <- dnorm(df$Exploitation40, pred.numer, summary(numer.mod)$sigma)
ipew.denominator <- dnorm(df$Exploitation40, pred.denom, summary(denom.mod)$sigma)


df <- df %>%
  mutate(
    ipew = ipew.numerator / ipew.denominator,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE),
      ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew)
    )
  )

df <- df %>%
  mutate(
    ipew = ipew.numerator / ipew.denominator,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE), 
                        ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew))
  )

```

### Probabily of censoring models

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

df <- df %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod.cens <- glm(K6_censored ~ Sex + Race_cat + N_Change_Occupation_Base + Depressed.Base  +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV + OT.Income_TV  +
    AlcFreq_TV + GradesCompl_TV + Hrly.Slry_TV + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV +
    Exploitation40 + Occupation_Cat + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age, data = df, weights = Individ.Weight, family = "quasibinomial",
  control = list(maxit = 100))


numer.mod.cens <- glm(K6_censored ~ Exploitation40 + Sex + Race_cat + N_Change_Occupation_Base  + Depressed.Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df, weights = Individ.Weight, family =
    "quasibinomial", control = list(maxit = 100))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = denom.mod.cens$model, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = numer.mod.cens$model, type = "response"))


pred.denom.cen <- 1 - as.numeric(predict(denom.mod.cens, newdata = df, type = "response"))
pred.numer.cen <- 1 - as.numeric(predict(numer.mod.cens, newdata = df, type = "response"))



df <- df %>%
  mutate(
    ipcw = pred.numer.cen /pred.denom.cen,
    ipcw = replace_na(ipcw, NA),
     ipcw_trunc = ifelse(ipcw > quantile(ipcw, .995, na.rm = TRUE), quantile(ipcw, .995, na.rm = TRUE), ipcw)
  )

summary(df$ipcw, na.rm = T)
```


### Create MSM weighting variable

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
df <- df %>% mutate(ipw = ipew * ipcw * Individ.Weight)

```



### Survey design object

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Create survey design object
df <- df %>%
  filter(!is.na(ipw))

df <- df %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df <- arrange(df, ID, Year)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df)


```


### Marginal structural model for mental illness 

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}



MSM_MI <- svyglm(MI_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
    Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50, family = binomial)

MSM_MI_tb <- tidy(MSM_MI, exponentiate = TRUE, conf.int = TRUE)
MSM_MI_tb <- MSM_MI_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI"
  )

```

### Marginal structural model for K6-continuous

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}


MSM_K6 <- svyglm(K6_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
    Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50)



MSM_K6_tb <- tidy(MSM_K6, conf.int = TRUE)
MSM_K6_tb <- MSM_K6_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "K6"
  )
```



### Results

#### Distribution of weights table
```{r, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)

Weights <- data.frame(Weight = c("IPEW", "IPCW"), Mean = c(mean(df$ipew, na.rm = TRUE), mean(df$ipcw, na.rm = TRUE)), SD = c(sd(df$ipew, na.rm = TRUE), sd(df$ipcw, na.rm = TRUE)), Min = c(min(df$ipew, na.rm = TRUE),  min(df$ipcw, na.rm = TRUE)), Max = c(max(df$ipew, na.rm = TRUE), max(df$ipcw, na.rm = TRUE)))

names(Weights) <- c("Weight", "Mean", "SD", "Min", "Max")



kable(Weights, digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "left") 

```


#### MSM effect estimates table

```{r}
MSM_K6_tb <- MSM_K6_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Psychological distress (K6 scale)") %>%
  select(Outcome, estimate, `95% CI`)
```

```{r}
MSM_MI_tb <- MSM_MI_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Mental Illness") %>%
  select(Outcome, estimate, `95% CI`)
```

## Quantile binning inverse probability of exposure weights

Note that the code below uses the same intermediate object names and will overwrite the objects from the above analysis. Change the names of the intermediate objects if you'd like to preserve the above analysis in working memory. 

### Probability of exposure models

```{r}
df_bin <- Full_CleanedData

df_bin <- filter(df_bin,  TotalLaborIncome_TV > MinWage, WorkHrs_TV >= 2080, Occupation_Base != "Military", Occupation_Cat != "Military")

df_bin <- as.data.frame(df_bin)
df_bin <- droplevels(df_bin)
```


```{r, eval=FALSE}
library(nnet)

df_bin$ExploitBin <- ntile(df_bin$Exploitation40, 10)

denom.mod <- multinom(ExploitBin ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
    Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L  + OT.Income_TV_L + Occupation_Cat_L +
  AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L +
  Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L +
  YearsWorked_TV_L  + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age + Year,
data = df_bin,
weights = Individ.Weight, maxit=1000, MaxNWts = 5000
)


pred.denom <- as.data.frame(predict(denom.mod, newdata = df_bin,  type = "probs"))

df_bin <- df_bin %>%
  mutate(
    ipew.denominator = pred.denom[cbind(seq_len(nrow(pred.denom)), match(df_bin$ExploitBin, colnames(pred.denom)))],
    ipew = (1/10) / ipew.denominator,
    ipew_trunc = ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew)
    )

```

### Probability of censoring models

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

df_bin <- df_bin %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Depressed.Base + Occupation_Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV + OT.Income_TV  +
    AlcFreq_TV + GradesCompl_TV + Hrly.Slry_TV + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV +
    Exploitation40 + Occupation_Cat + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age, data = df_bin, weights = Individ.Weight, family = "quasibinomial",
  control = list(maxit = 100))


numer.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Occupation_Base + Depressed.Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_bin, weights = Individ.Weight, family =
    "quasibinomial", control = list(maxit = 100))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = df_bin, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = df_bin, type = "response"))


df_bin <- df_bin %>%
  mutate(
    ipcw = ifelse(df_bin$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )



df_bin <- df_bin %>%
  mutate(
    ipcw = ifelse(df_bin$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA),
    ipcw_trunc = ifelse(ipcw > quantile(ipcw, .995, na.rm = TRUE), quantile(ipcw, .995, na.rm = TRUE), ipcw)
  )


```


### Create MSM weighting variable

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
df_bin <- df_bin %>% mutate(ipw = ipew_trunc * ipcw_trunc * Individ.Weight)
```

### Survey design object

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Create survey design object
df_bin <- df_bin %>%
  filter(!is.na(ipw))

df_bin <- df_bin %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df_bin <- arrange(df_bin, ID, Year)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df_bin)


```

### Marginal structural model for mental illness 
```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}


MSM_MI <- svyglm(MI_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
    Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50, family = binomial)

MSM_MI_bin_tb <- tidy(MSM_MI, exponentiate = TRUE, conf.int = TRUE)
MSM_MI_bin_tb <- MSM_MI_bin_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI"
  )

```

### Marginal structural model for K6-continuous

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}


MSM_K6 <- svyglm(K6_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
    Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50)


MSM_K6_bin_tb <- tidy(MSM_K6, conf.int = TRUE)
MSM_K6_bin_tb <- MSM_K6_bin_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "K6"
  )

```

### Results

#### Distribution of weights table
```{r,  eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)

Weights_bin <- data.frame(Weight = c("IPEW", "IPCW"), Mean = c(mean(df_bin$ipew_trunc, na.rm = TRUE), mean(df_bin$ipcw_trunc, na.rm = TRUE)), SD = c(sd(df_bin$ipew_trunc, na.rm = TRUE), sd(df_bin$ipcw_trunc, na.rm = TRUE)), Min = c(min(df_bin$ipew_trunc, na.rm = TRUE),  min(df_bin$ipcw_trunc, na.rm = TRUE)), Max = c(max(df_bin$ipew_trunc, na.rm = TRUE), max(df_bin$ipcw_trunc, na.rm = TRUE)))

names(Weights_bin) <- c("Weight", "Mean", "SD", "Min", "Max")



kable(Weights_bin, digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "left") 

```


#### MSM effect estimates table

```{r, eval=FALSE}
MSM_K6_bin_tb <- MSM_K6_bin_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Psychological distress (K6 scale)") %>%
  select(Outcome, estimate, `95% CI`)
```

```{r, eval=FALSE}
MSM_MI_bin_tb <- MSM_MI_bin_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Mental Illness") %>%
  select(Outcome, estimate, `95% CI`)
```


# Sensitivity Analyses 

## Restrict to workers paid hourly

```{r}
df_hrly <- filter(Full_CleanedData,  TotalLaborIncome_TV > MinWage, WorkHrs_TV >= 2080, Occupation_Base != "Military", Occupation_Cat != "Military", Hrly.Slry_TV == "Hourly")

df_hrly <- as.data.frame(df_hrly)
df_hrly <- droplevels(df_hrly)
```


Note that the code below uses many of the same intermediate object names and will overwrite the objects from the above analyses. Change the names of the intermediate objects if you'd like to preserve the above analyses in working memory. 

### Probability of exposure models

```{r, eval=FALSE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}

denom.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base +
     InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + Occupation_Base +
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L  + OT.Income_TV_L + Occupation_Cat_L +
  AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L +
  Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L +
  YearsWorked_TV_L  + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age + Year,
data = df_hrly,
weights = Individ.Weight
)


numer.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + 
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base,
data = df_hrly,
weights = Individ.Weight
)

pred.denom <- predict(denom.mod, newdata = denom.mod$model, type = "response")
pred.numer <- predict(numer.mod, newdata = numer.mod$model, type = "response")

ipew.numerator <- dnorm(df_hrly$Exploitation40, pred.numer, summary(numer.mod)$sigma)
ipew.denominator <- dnorm(df_hrly$Exploitation40, pred.denom, summary(denom.mod)$sigma)


df_hrly <- df_hrly %>%
  mutate(
    ipew = ipew.numerator / ipew.denominator,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE), 
                        ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew))
  )

summary(df_hrly$ipew)
```


### Probability of censoring models

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

df_hrly <- df_hrly %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Depressed.Base + Occupation_Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV + OT.Income_TV  +
    AlcFreq_TV + GradesCompl_TV  + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV +
    Exploitation40 + Occupation_Cat + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age, data = df_hrly, weights = Individ.Weight, family = "quasibinomial",
  control = list(maxit = 100))


numer.mod.cens <- glm(K6_censored ~ Exploitation40 + Sex + N_Change_Occupation_Base  + Depressed.Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_hrly, weights = Individ.Weight, family =
    "quasibinomial", control = list(maxit = 100))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = denom.mod.cens$model, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = numer.mod.cens$model, type = "response"))


df_hrly <- df_hrly %>%
  mutate(
    ipcw = ifelse(df_hrly$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )


df_hrly <- df_hrly %>%
  mutate(
    ipcw = ifelse(df_hrly$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA),
    ipcw_trunc = ifelse(ipcw > quantile(ipcw, .995, na.rm = TRUE), quantile(ipcw, .995, na.rm = TRUE), ipcw)
  )


summary(df_hrly$ipcw, na.rm = T)
```


### Create MSM weighting variable

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
df_hrly <- df_hrly %>% mutate(ipw = ipew * ipcw * Individ.Weight)

```

### Survey design object

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Create survey design object
df_hrly <- df_hrly %>%
  filter(!is.na(ipw))

df_hrly <- df_hrly %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df_hrly <- arrange(df_hrly, ID, Year)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df_hrly)


```

### Marginal structural model for mental illness 

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}



MSM_MI <- svyglm(MI_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50, family = binomial)



MSM_MI_hrly_tb <- tidy(MSM_MI, exponentiate = TRUE, conf.int = TRUE) 

MSM_MI_hrly_tb <- MSM_MI_hrly_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI"
  )

```

### Marginal structural model for K6-continuous

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}


MSM_K6 <- svyglm(K6_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base   + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50)


MSM_K6_hrly_tb <- tidy(MSM_K6, exponentiate = TRUE, conf.int = TRUE)


MSM_K6_hrly_tb <- MSM_K6_hrly_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI"
  )


```

### Results

#### Distribution of weights table
```{r, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)

Weights_hrly <- data.frame(Weight = c("IPEW", "IPCW"), Mean = c(mean(df_hrly$ipew, na.rm = TRUE),  mean(df_hrly$ipcw, na.rm = TRUE)),SD = c(sd(df_hrly$ipew, na.rm = TRUE), sd(df_hrly$ipcw, na.rm = TRUE)), Min = c(min(df_hrly$ipew, na.rm = TRUE),  min(df_hrly$ipcw, na.rm = TRUE)), Max = c(max(df_hrly$ipew, na.rm = TRUE), max(df_hrly$ipcw, na.rm = TRUE)))

names(Weights_hrly) <- c("Weight", "Mean", "SD",  "Min", "Max")



kable(Weights_hrly, digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "left") 

```


#### MSM effect estimates table

```{r}
MSM_K6_hrly_tb <- MSM_K6_hrly_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Psychological distress (K6 scale)") %>%
  select(Outcome, estimate, `95% CI`)
```

```{r}
MSM_MI_hrly_tb <- MSM_MI_hrly_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Mental Illness") %>%
  select(Outcome, estimate, `95% CI`)
```

## Restrict to salaried workers

```{r}
df_slry <- filter(Full_CleanedData,  TotalLaborIncome_TV > MinWage, WorkHrs_TV >= 2080, Occupation_Base != "Military", Occupation_Cat != "Military",  Hrly.Slry_TV == "Salary")

df_slry <- as.data.frame(df_slry)
df_slry <- droplevels(df_slry)

```


### Probabilty of exposure models

```{r, eval=FALSE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}


denom.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L  + OT.Income_TV_L + Occupation_Cat_L +
  AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L  + SpouseIncome_TV_L + UnionCovered_TV_L +
  YearsWorked_TV_L  + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age + Year,
data = df_slry,
weights = Individ.Weight
)

numer.mod <- lm(Exploitation40 ~ Exploitation40_L + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base,
data = df_slry,
weights = Individ.Weight
)

pred.denom <- predict(denom.mod, newdata = denom.mod$model, type = "response")
pred.numer <- predict(numer.mod, newdata = numer.mod$model, type = "response")

ipew.numerator <- dnorm(df_slry$Exploitation40, pred.numer, summary(numer.mod)$sigma)
ipew.denominator <- dnorm(df_slry$Exploitation40, pred.denom, summary(denom.mod)$sigma)


df_slry <- df_slry %>%
  mutate(
    ipew = ipew.numerator / ipew.denominator,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE), 
                        ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew))
  )


summary(df_slry$ipew, na.rm = T)

```


### Probability of censoring models

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

df_slry <- df_slry %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Depressed.Base  + Occupation_Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV + OT.Income_TV  +
    AlcFreq_TV + GradesCompl_TV  + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV +
    Exploitation40 + Occupation_Cat + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age, data = df_slry, weights = Individ.Weight, family = "quasibinomial",
  control = list(maxit = 100))


numer.mod.cens <- glm(K6_censored ~ Exploitation40 + Sex + N_Change_Occupation_Base  + Depressed.Base + Occupation_Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_slry, weights = Individ.Weight, family =
    "quasibinomial", control = list(maxit = 100))

pred.denom.cen <- as.numeric(predict(denom.mod.cens, newdata = denom.mod.cens$model, type = "response"))
pred.numer.cen <- as.numeric(predict(numer.mod.cens, newdata = numer.mod.cens$model, type = "response"))


df_slry <- df_slry %>%
  mutate(
    ipcw = ifelse(df_slry$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA)
  )



df_slry <- df_slry %>%
  mutate(
    ipcw = ifelse(df_slry$K6_censored == 0, ((1 - pred.numer.cen) / (1 - pred.denom.cen)), 1),
    ipcw = replace_na(ipcw, NA),
    ipcw_trunc = ifelse(ipcw > quantile(ipcw, .999, na.rm = TRUE), quantile(ipcw, .999, na.rm = TRUE), ipcw),
    #ipcw_trunc2 = ifelse(ipcw_trunc < quantile(ipcw_trunc, 0.001, na.rm = T), quantile(ipcw_trunc, .001, na.rm = T), ipcw_trunc)
  )


summary(df_slry$ipcw_trunc)

```


### Create MSM weighting variable

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
df_slry <- df_slry %>% mutate(ipw = ipew * ipcw * Individ.Weight)

```

### Survey design object

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Create survey design object
df_slry <- df_slry %>%
  filter(!is.na(ipw))

df_slry <- df_slry %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df_slry <- arrange(df_slry, ID, Year)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df_slry)


```

### Marginal structural model for mental illness 

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}



MSM_MI <- svyglm(MI_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base   + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50, family = binomial)



MSM_MI_slry_tb <- tidy(MSM_MI, exponentiate = TRUE, conf.int = TRUE) 


MSM_MI_slry_tb <- MSM_MI_slry_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI"
  )

```

### Marginal structural model for K6-continuous

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}


MSM_K6 <- svyglm(K6_TV ~ Exploitation40 + Sex + Race_cat + Depressed.Base + DrugProb.Base + Occupation_Base +
     N_Change_Employ_Base + N_Change_Industry_Base + EmploymentStatus.Base + N_Change_Occupation_Base  + InterestIncome.Base +  Yrs_Self_Emp_Base + Hrly.Slry.Base + 
    SpouseIncome.Base + Yrs_Union_Cov_Base +  ExtraJobIncome.Base + Annual.OT.Hrs.Base + 
    OT.Income.Base + Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50)


MSM_K6_slry_tb <- tidy(MSM_K6, exponentiate = TRUE, conf.int = TRUE) 


MSM_K6_slry_tb <- MSM_K6_slry_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate(
    Outcome = "MI"
  )

```

### Results

#### Distribution of weights table
```{r, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)

Weights_slry <- data.frame(Weight = c("IPEW", "IPCW"), Mean = c(mean(df_slry$ipew, na.rm = TRUE), mean(df_slry$ipcw_trunc, na.rm = TRUE)), SD = c(sd(df_slry$ipew, na.rm = TRUE), sd(df_slry$ipcw_trunc, na.rm = TRUE)), Min = c(min(df_slry$ipew, na.rm = TRUE),  min(df_slry$ipcw_trunc, na.rm = TRUE)), Max = c(max(df_slry$ipew, na.rm = TRUE), max(df_slry$ipcw_trunc, na.rm = TRUE)))

names(Weights_slry) <- c("Weight", "Mean", "SD", "Min", "Max")



kable(Weights_slry, digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "left") 

```


#### MSM effect estimates table

```{r}
MSM_K6_slry_tb <- MSM_K6_slry_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Psychological distress (K6 scale)") %>%
  select(Outcome, estimate, `95% CI`)
```

```{r}
MSM_MI_slry_tb <- MSM_MI_slry_tb %>% 
  filter(term == "Exploitation40") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Mental Illness") %>%
  select(Outcome, estimate, `95% CI`)
```

## Overwork hours 

### Reload data
```{r}
df_overwork <- Full_CleanedData

df_overwork <- filter(df_overwork,  TotalLaborIncome_TV > MinWage, WorkHrs_TV >= 2080, Occupation_Base != "Military", Occupation_Cat != "Military")

df_overwork <- as.data.frame(df_overwork)
df_overwork <- droplevels(df_overwork)
```


### Probabilty of exposure models

```{r, eval=FALSE, echo=TRUE, results="hide", message=FALSE, warning=FALSE}


denom.mod <- lm(Exploitation_Hours_52 ~ Sex + Race_cat + N_Change_Occupation_Base +
  Occupation_Base + Depressed.Base + N_Change_Employ_Base +
  EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
  Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base +
  ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
  Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV_L +
  OT.Hrs.Main.Job_L + OT.Income_TV_L  +
  AlcFreq_TV_L + GradesCompl_TV_L + InterestIncome_TV_L + OwnRent_TV_L +
  Hrly.Slry_TV_L + SpouseIncome_TV_L + UnionCovered_TV_L +
  YearsWorked_TV_L + Exploitation_Hours_52_L + TotalLaborIncome_TV_L + WorkHrs_TV_L + Age + Year,
data = df_overwork,
weights = Individ.Weight
)


numer.mod <- lm(Exploitation_Hours_52 ~ Exploitation_Hours_52_L + Sex + Race_cat + N_Change_Occupation_Base +
  Occupation_Base + Depressed.Base + N_Change_Employ_Base +
  EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
  Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base +
  ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
  Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base,
data = df_overwork,
weights = Individ.Weight
)

pred.denom <- predict(denom.mod, newdata = denom.mod$model, type = "response")
pred.numer <- predict(numer.mod, newdata = numer.mod$model, type = "response")

ipew.numerator <- dnorm(df_overwork$Exploitation_Hours_52, pred.numer, summary(numer.mod)$sigma)
ipew.denominator <- dnorm(df_overwork$Exploitation_Hours_52, pred.denom, summary(denom.mod)$sigma)


df_overwork <- df_overwork %>%
  mutate(
    ipew = ipew.numerator / ipew.denominator,
    ipew.trunc = ifelse(ipew < quantile(ipew, 0.1, na.rm = TRUE), quantile(ipew, 0.1, na.rm = TRUE), 
                        ifelse(ipew > quantile(ipew, 0.99, na.rm = TRUE), quantile(ipew, 0.99, na.rm = TRUE), ipew))
  )

summary(df_overwork$ipew, na.rm = T)

```


### Probability of censoring models

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}

df_overwork <- df_overwork %>% mutate(
  K6_censored = as.factor(as.numeric(is.na(K6_TV)))
)

denom.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Depressed.Base + Occupation_Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base + Annual.OT.Hrs_TV + OT.Income_TV  +
    AlcFreq_TV + GradesCompl_TV + Hrly.Slry_TV + SpouseIncome_TV + UnionCovered_TV + YearsWorked_TV +
    Exploitation_Hours + Occupation_Cat+ TotalLaborIncome_TV_L + WorkHrs_TV_L + Age, data = df_overwork, weights = Individ.Weight, family = "quasibinomial",
  control = list(maxit = 100))


numer.mod.cens <- glm(K6_censored ~ Sex + N_Change_Occupation_Base + Occupation_Base + Depressed.Base +
    N_Change_Employ_Base + EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
    Hrly.Slry.Base + Yrs_Union_Cov_Base + ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
    Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, data = df_overwork, weights = Individ.Weight, family =
    "quasibinomial", control = list(maxit = 100))

pred.denom.cen <- 1 - as.numeric(predict(denom.mod.cens, newdata = df_overwork, type = "response"))
pred.numer.cen <- 1 - as.numeric(predict(numer.mod.cens, newdata = df_overwork, type = "response"))



df_overwork <- df_overwork %>%
  mutate(
    ipcw = pred.numer.cen /pred.denom.cen,
    ipcw = replace_na(ipcw, NA),
     ipcw_trunc = ifelse(ipcw > quantile(ipcw, .995, na.rm = TRUE), quantile(ipcw, .995, na.rm = TRUE), ipcw)
  )

sd(df_overwork$ipcw_trunc, na.rm = T)
```


### Create MSM weighting variable

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
df_overwork <- df_overwork %>% mutate(ipw = ipew * ipcw_trunc * Individ.Weight)
```



### Survey design object

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Create survey design object
df_overwork <- df_overwork %>%
  filter(!is.na(ipw))

df_overwork <- df_overwork %>% mutate(
  MI_TV = ifelse(K6_TV >= 5, 1, 0)
)

df_overwork <- arrange(df_overwork, ID, Year)

options(survey.lonely.psu = "average")
svy_obj <- svydesign(ids = ~SampErrClust, strata = ~SampErrStrat, weights = ~ipw, nest = TRUE, data = df_overwork)
```



### Marginal structural model for mental illness

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}



MSM_MI <- svyglm(MI_TV ~ Exploitation_Hours_52 + Sex + Race_cat + N_Change_Occupation_Base +
  Occupation_Base + Depressed.Base + N_Change_Employ_Base +
  EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
  Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base +
  ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
  Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50, family = binomial)

MSM_MI_overwork_tb <- tidy(MSM_MI,  conf.int = TRUE)
MSM_MI_overwork_tb <- MSM_MI_overwork_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ .*52) %>% 
  mutate_if(is.numeric, ~ exp(.)) %>% 
  mutate_if(is.numeric, ~ round(., 2)) %>% 
  mutate(
    Outcome = "MI",
    Weighting = "Survey, exposure, censoring"
  )


```

### Marginal structural model for K6-continuous

```{r, eval=FALSE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}


MSM_K6 <- svyglm(K6_TV ~ Exploitation_Hours_52 + Sex + Race_cat + N_Change_Occupation_Base +
  Occupation_Base + Depressed.Base + N_Change_Employ_Base +
  EmploymentStatus.Base + InterestIncome.Base + Yrs_Self_Emp_Base +
  Hrly.Slry.Base + SpouseIncome.Base + Yrs_Union_Cov_Base +
  ExtraJobIncome.Base + Annual.OT.Hrs.Base + OT.Income.Base +
  Yrs.Extra.Job_Base + Hrs.Extra.Jobs.Base, design = svy_obj, maxit = 50)


MSM_K6_overwork_tb <- tidy(MSM_K6, conf.int = TRUE)
MSM_K6_overwork_tb <- MSM_K6_overwork_tb %>%
  select(term, estimate, conf.low, conf.high) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>%
  mutate_if(is.numeric, ~.*52) %>% 
  mutate(
    Outcome = "K6",
    Weighting = "Survey, exposure, censoring"
  )
```

### Results

#### Distribution of weights table
```{r, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)

Weights_overwork <- data.frame(Weight = c("IPEW", "IPCW"), Mean = c(mean(df_overwork$ipew, na.rm = TRUE), mean(df_overwork$ipcw, na.rm = TRUE)), SD = c(sd(df_overwork$ipew, na.rm = TRUE), sd(df_overwork$ipcw, na.rm = TRUE)), Min = c(min(df_overwork$ipew, na.rm = TRUE),  min(df_overwork$ipcw, na.rm = TRUE)), Max = c(max(df_overwork$ipew, na.rm = TRUE), max(df_overwork$ipcw, na.rm = TRUE)))

names(Weights_overwork) <- c("Weight", "Mean", "SD", "Min", "Max")



kable(Weights_overwork, digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "left") 

```


#### MSM effect estimates table

```{r}
MSM_K6_overwork_tb <- MSM_K6_overwork_tb %>% 
  filter(term == "Exploitation_Hours_52") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Psychological distress (K6 scale)") %>%
  select(Outcome, estimate, `95% CI`)
```

```{r}
MSM_MI_overwork_tb <- MSM_MI_overwork_tb %>% 
  filter(term == "Exploitation_Hours_52") %>%
  select(estimate, conf.low, conf.high) %>%
  mutate(`95% CI` = paste0(paste("("), paste(conf.low), paste(","), paste(" "), paste(conf.high), paste(")")),
    Outcome = "Mental Illness") %>%
  select(Outcome, estimate, `95% CI`)
```


# Manuscript Tables


## Weights
```{r}

Weights_tab <- as.data.frame(rbind(Weights, Weights_bin, Weights_hrly, Weights_slry, Weights_overwork ))

Weights_tab <- Weights_tab %>% 
  mutate(across(where(is.numeric), ~ round(., 2))) %>% 
  mutate(Analysis = rep(c("Exploitation, normal distribution", "Exploitation, quantile binning", "Exploitation, normal distribution, hourly only", "Exploitation, normal distribution, salary only", "Overwork hours per week, normal distribution"), each = 2),
         Weight = c("Exposure", "Censoring", "Exposure (truncated at 99th percentile)", "Censoring (truncated at 99.5th percentile", "Exposure", "Censoring", "Exposure", "Censoring", "Exposure", "Censoring (truncated at 99.5th percentile")
  ) %>% 
  select(Analysis, Weight, everything())
  
kable(Weights_tab, digits = 2) %>% 
  kable_styling(bootstrap_options = c("hover"), full_width = F, position = "left") %>% 
  collapse_rows(columns = 1:2, valign = "top")
```

## MSM estimates

```{r}

MSM_K6_Estimates <- rbind(MSM_K6_tb, MSM_K6_bin_tb, MSM_K6_hrly_tb, MSM_K6_slry_tb, MSM_K6_overwork_tb)

MSM_K6_Estimates$Outcome <- c("Exploitation, normal distribution", "Exploitation, quantile binning", "Exploitation, normal distribution, hourly only", "Exploitation, normal distribution, salary only", "Overwork hours per week, normal distribution")

MSM_MI_Estimates <- rbind(MSM_MI_tb, MSM_MI_bin_tb, MSM_MI_hrly_tb, MSM_MI_slry_tb, MSM_MI_overwork_tb)

MSM_MI_Estimates <- MSM_MI_Estimates %>% 
  select(-Outcome)

MSM_Table <- cbind(MSM_K6_Estimates, MSM_MI_Estimates)

names(MSM_Table) <- c("Exposure", "Beta", "95% CI", "OR", "95% CI")

MSM_Table %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("hover"), full_width = F, position = "left") %>% 
  add_header_above(c(" " = 1, "Psychological distress" = 2, "Mental illness" = 2))
```




