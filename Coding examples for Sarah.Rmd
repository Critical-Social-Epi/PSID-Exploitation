---
title: "SER Abstract Analysis - Heads of Household Only"
output: html_notebook
---

```{r, setup}
library(tidyverse)
library(magrittr)
library(dplyr)
load("/Users/SJP1/Dropbox/Gender economics/Exploitation IPW-MSM/PSID-Exploitation/AnalysisData.Rdata")

```

#Restrict data to heads of household (since only they are asked K6)
```{r}

df <- AnalysisData %>% 
                    select(-contains(".Spouse")) %>% 
                    filter(RelationToHead==10)
```

#For every respondent from 2003-2015 (when K6 asked), go back as far as their first year of participation
```{r}
UniqueIDs <- df %>% filter(Year %in% c("2003", "2005", "2007", "2009", "2011", "2013", "2015"))
UniqueIDs <- unique(UniqueIDs$ID)
df <- df %>% filter(ID %in% UniqueIDs)
df$ID<-as.factor(df$ID)

df %>% group_by(Year) %>% summarize(max(Age.Head, na.rm=TRUE))

quantile(df$AgeDrEmotProb.Head, probs=seq(0,1,0.01), na.rm=TRUE)
table(df$AgeDrEmotProb.Head)

table(df$DrEmotProb.Head)
table(df$AgeDrEmotProb.Head>0)
```



#Check variable value options for Qs asked every year
```{r}
# Recode Age

df$Year <- as.numeric(df$Year)

df <- df %>% mutate(Age.Head = ifelse(Year %in% c(1983:1993) & Age.Head>98, NA, ifelse(Year %in% c(1994:1996) &
                                  Age.Head %in% c(0,98,99), NA, ifelse(Year %in% c(1997:2015) & Age.Head > 120, NA,
                                  Age.Head))))
                    
                    
                    
                    
                  


#For Dr


df$AgeDrEmotProb.Head<-ifelse(df$AgeDrEmotProb.Head>0, df$AgeDrEmotProb.Head, NA)
df$AgeDrLearnDisord.Head<-ifelse(df$AgeDrLearnDisord.Head>0, df$AgeDrLearnDisord.Head, NA)
##alcohol coding--approximately drinks/week
## if they don't drink, treat as 0/week
## if they drink less than once/week, treat as 0/week
## otherwise this is semicontinuous - if they drink several times a week, multiplyby 3
## if they drink every day, mulitply by 7
df$DrinksPerDay.Head <- ifelse(df$DrinksPerDay.Head %in% c(1:25), df$DrinksPerDay.Head, ifelse(df$DrinksPerDay.Head==0, 0, NA))
df$DrinksPerDay.Head<-as.numeric(df$DrinksPerDay.Head)
df$AlcFreq<-ifelse(df$AlcFreq.Head %in% c(0:3), 0, ifelse(df$AlcFreq.Head==4, df$DrinksPerDay.Head, ifelse(df$AlcFreq.Head==5, df$DrinksPerDay.Head*3, ifelse(df$AlcFreq.Head==6, df$DrinksPerDay.Head*7, NA))))

df$ConditionPsych.Head <-ifelse(df$ConditionPsych.Head %in% c(1:9), df$ConditionPsych.Head, NA)
df$Depressed17.Head<-ifelse(df$Depressed17.Head ==1, 1, ifelse(df$Depressed17.Head ==5,0, NA))
df$DrugProb17.Head <- ifelse(df$DrugProb17.Head ==1, 1, ifelse(df$DrugProb17.Head ==5, 0, NA))
df$DrEmotProb.Head<-ifelse(df$DrEmotProb.Head ==1, 1, ifelse(df$DrEmotProb.Head ==5, 0, NA))
df$DrLearnDisord.Head<-ifelse(df$DrLearnDisord.Head ==1, 1, ifelse(df$DrLearnDisord.Head ==5, 0, NA))
df$DrMemLoss.Head<-ifelse(df$DrMemLoss.Head ==1, 1, ifelse(df$DrMemLoss.Head ==5, 0, NA))
df$EmotProb.Head<-ifelse(df$EmotProb.Head ==1, 1, ifelse(df$EmotProb.Head ==5, 0, NA))
####Employment levels: 1=working, 2=laid off temporarily or looking for work, 3= retired or housewife, 4=permanently disabled, 5=student
df$EmployedNow<-ifelse(df$EmployedNow1.Head==1|df$EmployedNow2.Head==1, 1, ifelse(df$EmployedNow1.Head %in% c(2, 3)|df$EmployedNow2.Head %in% c(2, 3), 2, ifelse(df$EmployedNow1.Head %in% c(4, 6)|df$EmployedNow2.Head %in% c(4,6), 3, ifelse(df$EmployedNow1.Head==5|df$EmployedNow2.Head==5, 4, ifelse(df$EmployedNow1.Head==7|df$EmployedNow2.Head==7, 5, NA)))))

df$EverSmoked.Head <-ifelse(df$EverSmoked.Head ==1, 1, ifelse(df$EverSmoked.Head ==5,0, NA))
df$FamilySize<-ifelse(df$FamilySize < 99, df$FamilySize, NA)
#binarize general health - 1 if fair or poor
df$GenHealth <- ifelse(df$GenHealth %in% c(1:3), 0, ifelse(df$GenHealth %in% c(4,5), 1, NA))
#did you ever have poor health as a kid? 1 for fair/poor ever
df$KidHealth<-ifelse(df$KidHealth.Head %in% c(1:3), 0, ifelse(df$KidHealth.Head %in% c(4,5),1, NA))

#lt high school, 12=high school, 13-15 = some college, 16=college, 17=more than college
df$GradesCompl <- ifelse(df$GradesCompl %in% c(1:17), df$GradesCompl, NA)

df$HealthInsNow<-ifelse(df$HealthInsNow ==1, 1, ifelse(df$HealthInsNow ==5, 0, NA))
df$Industry<-ifelse(df$Year<=1980, df$Industry1980.Head, ifelse(df$Year>1980 & df$Year<=2001, df$Industry2001.Head, ifelse(df$Year>2001, df$Industry2015.Head, NA)))
df$Industry <- ifelse(df$Industry != 999 & df$Industry != 0, df$Industry, NA)
df$InsuredAnyone<-ifelse(df$Insurance2==1 | df$InsuranceHeadFam %in% c(1,2), 1, ifelse(df$Insurance2==5|df$InsuranceHeadFam %in% c(4,5),0,NA))

#InterestIncome.Head can be coded as is - continuous
df$K6.Head <- ifelse(df$K6.Head<99, df$K6.Head, NA)
df$MedforPsych.Head<-ifelse(df$MedforPsych.Head == 1, 1, ifelse(df$MedforPsych.Head %in% c(0,5), 0, NA))
df$Medicaid<-ifelse(df$Medicaid ==1, 1, ifelse(df$Medicaid ==5, 0, NA))
df$MedLearnDisord.Head<-ifelse(df$MedLearnDisord.Head == 1, 1, ifelse(df$MedLearnDisord.Head %in% c(0,5), 0, NA))
df$Occupation<-ifelse(df$Year<=1980, df$Occupation1980.Head, ifelse(df$Year>1980 & df$Year<=2001, df$Occupation2001.Head, ifelse(df$Year>2001, df$Occupation2015.Head, NA)))
df$Occupation <- ifelse(df$Occupation != 998 & df$Occupation!=999 & df$Occupation!=0, df$Occupation, NA)
df$Race.Head<-ifelse(df$Race %in% c(1:2), df$Race.Head, ifelse(df$Race.Head %in% c(3:7), 3, NA))
df$OwnRent<-ifelse(df$OwnRent %in% c(1,5), df$OwnRent, NA)
df$Self.Head<-ifelse(df$SelEmp2001.Head %in% c(1:3) & df$Year<= 2001, df$SelEmp2001.Head, ifelse(df$SelfEmp2015.Head %in% c(1:3) & df$Year >2001, df$SelfEmp2015.Head, NA))
##1 = employed for someone else, 2 = self + someone else, 3 = self only
##TotalLaborIncome.Head not recoded - continuous
df$UnionCovered.Head <-ifelse(df$UnionCovered.Head ==1, 1, ifelse(df$UnionCovered.Head ==5, 0, NA))
df$UnionMember<-ifelse(df$UnionMember1968.Head==0 & df$Year==1968, 0, ifelse(df$UnionMember1968.Head %in% c(1:8) &df$Year==1968, 1, ifelse(df$UnionMember1981.Head==1 & df$Year>1968, 1, ifelse(df$UnionMember1981.Head==5, 0, NA))))
df$YearsWorked.Head <- ifelse(df$YearsWorked.Head>0 & df$YearsWorked.Head<98, df$YearsWorked.Head, NA)  
df$WorkHrs.Head <- ifelse(df$WorkHrs.Head > 0 , df$WorkHrs.Head, NA)
                              

df$AgeDrEmotProb.Head<-as.numeric(df$AgeDrEmotProb.Head)
df$Race.Head<-as.numeric(df$Race.Head)
df$AgeDrLearnDisord.Head<-as.numeric(df$AgeDrLearnDisord.Head)
df$Depressed17.Head<-as.numeric(df$Depressed17.Head)
df$DrugProb17.Head<-as.numeric(df$DrugProb17.Head)
df$EmotProb.Head<-as.numeric(df$EmotProb.Head)
df$DrEmotProb.Head<-as.numeric(df$DrEmotProb.Head)
df$DrLearnDisord.Head<-as.numeric(df$DrLearnDisord.Head)
df$DrMemLoss.Head<-as.numeric(df$DrMemLoss.Head)
df$EverSmoked.Head<-as.numeric(df$EverSmoked.Head)
df$KidHealth<-as.numeric(df$KidHealth)

## recoding variables for "first mention" to avoid reporting inconsistencies
df<- df %>% group_by(ID) %>% mutate(
  AgeDrEmotProb.Head = dplyr::first(na.omit(AgeDrEmotProb.Head)),
  Race = dplyr::first(na.omit(Race.Head)),
  AgeDrLearnDisord.Head = dplyr::first(na.omit(AgeDrLearnDisord.Head)),
  Depressed17.Head = dplyr::first(na.omit(Depressed17.Head)),
  DrugProb17.Head = dplyr::first(na.omit(DrugProb17.Head)),
  EmotProb.Head = dplyr::first(na.omit(EmotProb.Head))
  ## for ones that are non-time varying ("ever" questions but that might change over survey period, coding them as yes if they EVER endorse yes)
  %>% mutate(
    (DrEmotProb.Head = dplyr::max(DrEmotProb.Head)),
    (DrLearnDisord.Head = dplyr::max(DrLearnDisord.Head)),
    (DrMemLoss.Head = dplyr::max(DrMemLoss.Head)),
    (EverSmoked.Head = dplyr::max(EverSmoked.Head)),
    (KidHealth.Head = dplyr::max(KidHealth))

))


```

#Recode industries and occupations into standard groups, 1970s codes and 2000s codes, collapse into one variable

```{r}

df <- df %>% filter(Year %in% c(2003, 2005, 2007, 2009, 2011, 2013, 2015))
df$Industry <- as.numeric(df$Industry)

df$Industry <-
ifelse(df$Industry>=17 & df$Industry<=29, "Agra/Forest/Fish/Hunt",
ifelse(df$Industry>=37 & df$Industry<=49, "Mining",
ifelse(df$Industry>=57 & df$Industry<=69, "Utilities",
ifelse(df$Industry==77, "Construction",
ifelse(df$Industry>=107 & df$Industry<=399, "Manufacturing",
ifelse(df$Industry>=407 & df$Industry<=459, "Wholesale Trade",
ifelse(df$Industry>=467 & df$Industry<=579, "Retail Trade",
ifelse(df$Industry>=607 & df$Industry<=639, "Transport/Warehousing",
ifelse(df$Industry>=647 & df$Industry<=679, "Information",
ifelse(df$Industry>=687 & df$Industry<=699, "Finance and Insurance",
ifelse(df$Industry>=707 & df$Industry<=719, "Real Estate",
ifelse(df$Industry>=727 & df$Industry<=749, "Pro/Sci/Tech Services",
ifelse(df$Industry>=757 & df$Industry<=779, "Management/Admin&Support/Waste Management",
ifelse(df$Industry>=786 & df$Industry<=789, "Educational Services",
ifelse(df$Industry>=797 & df$Industry<=847, "Health Care/Soc Assistance",
ifelse(df$Industry>=856 & df$Industry<=859, "Arts/Ent/Rec",
ifelse(df$Industry>=866 & df$Industry<=869, "Accomm/Food Services",
ifelse(df$Industry>=877 & df$Industry<=929, "Other Services",
ifelse(df$Industry>=937 & df$Industry<=959, "Public Administration",
ifelse(df$Industry==999, "DK/NA/R",
ifelse(df$Industry==0, "Inap", NA)))))))))))))))))))))

df$Industry <-as.factor(df$Industry)


df$Occupation <- as.numeric(df$Occupation)

df$Occupation<-ifelse(df$Occupation>=1 & df$Occupation<=43, "Management",  
ifelse(df$Occupation>=50 & df$Occupation<=73, "Business Operations Specialists",  
ifelse(df$Occupation>=80 & df$Occupation<= 95, "Financial Specialists",  
ifelse(df$Occupation>=100 & df$Occupation<=124, "Computer/Mathematical",  
ifelse(df$Occupation>=130 & df$Occupation<=156, "Architecture/Engineering",  
ifelse(df$Occupation>=160 & df$Occupation<=196, "Life, Phys, Soc Sciences",  
ifelse(df$Occupation>=200 & df$Occupation<=206, "Community/Soc Services",  
ifelse(df$Occupation>=210 & df$Occupation<=215, "Legal",  
ifelse(df$Occupation>=220 & df$Occupation<=255, "Education, Training, and Library",  
ifelse(df$Occupation>=260 & df$Occupation<=296, "Arts/Entertainment",  
ifelse(df$Occupation>=300 & df$Occupation<=354, "Healthcare Practitioner/Tech",  
ifelse(df$Occupation>=360 & df$Occupation<=365, "Healthcare Support",  
ifelse(df$Occupation>=370 & df$Occupation<=395, "Protective Services",  
ifelse(df$Occupation>=400 & df$Occupation<=416, "Food Prep/Serving",  
ifelse(df$Occupation>=420 & df$Occupation<=425, "Building/Grounds Maintenance",  
ifelse(df$Occupation>=430 & df$Occupation<=465, "Personal Care/Service",  
ifelse(df$Occupation>=470 & df$Occupation<=496, "Sales",  
ifelse(df$Occupation>=500 & df$Occupation<=593, "Office/Admin Support",  
ifelse(df$Occupation>=600 & df$Occupation<=613, "Farming/Fishing/Forestry",  
ifelse(df$Occupation>=620 & df$Occupation<=694, "Construction/Extraction",  
ifelse(df$Occupation>=700 & df$Occupation<=762, "Installation/Maintenance/Repair",  
ifelse(df$Occupation>=770 & df$Occupation<=896, "Production Operations",  
ifelse(df$Occupation>=900 & df$Occupation<=975, "Transportation/Material Moving",  
ifelse(df$Occupation>=980 & df$Occupation<=983, "Military",  
ifelse(df$Occupation==615, "Wild Code",  
ifelse(df$Occupation==999, "DK/NA/R",  
ifelse(df$Occupation==0, "Inap", NA)))))))))))))))))))))))))))

df$Occupation <- as.factor(df$Occupation)

df <- droplevels(df)

```

#Create Serious and moderate mental illness variables and exploitation variable
```{r}

df <- df %>% filter(TotalLaborIncome < quantile(TotalLaborIncome, 0.99, na.rm=TRUE) &  EmployedNow==1 & RelationToHead==10) 


df$SMI <- ifelse(df$K6.Head>=13 & df$K6.Head!=99, 1, ifelse(!is.na(df$K6.Head), 0, NA))
df$MMI <- ifelse(df$K6.Head>=5 & df$K6.Head<13 & df$K6.Head!=99, 1, ifelse(!is.na(df$K6.Head), 0, NA))



df$HourlyWage40 <- ifelse(df$WorkHrs>=2080 , (df$TotalLaborIncome)/2080, NA)

df$TrueHourlyWage <- ifelse(df$WorkHrs>=2080, (df$TotalLaborIncome)/(df$WorkHrs), NA)

df$Exploitation <- (df$HourlyWage40 - df$TrueHourlyWage) / df$HourlyWage40

```



# CODING EXAMPLES FOR SARA

## Get the first mention of variable

```{r}

df$AgeDrEmotProb.Head <- ifelse(df$AgeDrEmotProb.Head==0, NA, df$AgeDrEmotProb.Head)

df <- df %>% group_by(ID) %>% 
  mutate(AgeDrEmotProb.Head.baseline = first(na.omit(AgeDrEmotProb.Head)))

df[,c("Year", "ID", "AgeDrEmotProb.Head", "AgeDrEmotProb.Head.baseline")]

#Surprisingly, a bunch of people change their answers -- but I think first mention is fine. 

```

## If ever endorsed, positive

```{r}
table(df$DrEmotProb.Head)

df <- df %>% group_by(ID) %>% 
  mutate(DrEmotProb.ever = any(DrEmotProb.Head==1))

df[,c("Year", "ID", "DrEmotProb.Head", "DrEmotProb.ever")]
```

